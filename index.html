<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Ventas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc, onSnapshot, query, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // Firebase Configuration and Initialization (DO NOT CHANGE)
        const __app_id = 'default-app-id';
        const __firebase_config = '{"apiKey":"AIzaSyAiitXEEekD-7FD7kDxDIcRbxlClsF5gHU","authDomain":"ventas-9a210.firebaseapp.com","projectId":"ventas-9a210","storageBucket":"ventas-9a210.firebasestorage.app","messagingSenderId":"815890981146","appId":"1:815890981146:web:938fe5e09babe511e98ca3","measurementId":"G-N0QXG70WM1"}';
        const __initial_auth_token = '';

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let userId = null;
        let isAuthReady = false;
        let productSuggestions = new Set();
        let presentationSuggestions = new Set();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("Usuario autenticado: ", userId);
                document.getElementById('login-container').classList.add('hidden');
                document.getElementById('main-menu-container').classList.remove('hidden');
                isAuthReady = true;
                // Load suggestions when the user logs in
                loadSuggestions();
            } else {
                userId = null;
                console.log("No hay usuario autenticado.");
                document.getElementById('login-container').classList.remove('hidden');
                document.getElementById('main-menu-container').classList.add('hidden');
                isAuthReady = false;
                // Use anonymous sign-in if the custom token is not available
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token !== '') {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (error) {
                        console.error("Error al iniciar sesión con token personalizado:", error);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            }
        });

        // Login Logic
        window.login = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage("Inicio de sesión exitoso.", 'success');
            } catch (error) {
                console.error("Error al iniciar sesión:", error);
                showMessage("Error en el inicio de sesión. Verifica tu correo y contraseña.", 'error');
            }
        };

        // Registration Logic
        window.register = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessage("Registro exitoso. ¡Inicia sesión para continuar!", 'success');
            } catch (error) {
                console.error("Error al registrarse:", error);
                showMessage("Error en el registro. " + error.message, 'error');
            }
        };

        // Logout Logic
        window.logout = async () => {
            try {
                await signOut(auth);
                showMessage("Sesión cerrada.", 'info');
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                showMessage("Error al cerrar sesión.", 'error');
            }
        };

        // UI navigation
        function hideAllInventorySections() {
            document.getElementById('inventory-sub-menu').classList.add('hidden');
            document.getElementById('inventory-list-view').classList.add('hidden');
            document.getElementById('add-edit-view').classList.add('hidden');
            document.getElementById('modify-delete-view').classList.add('hidden');
            document.getElementById('modify-quantity-view').classList.add('hidden');
        }

        window.showInventory = () => {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('inventory-section').classList.remove('hidden');
            hideAllInventorySections();
            document.getElementById('inventory-sub-menu').classList.remove('hidden');
        };

        window.showInventoryList = () => {
            hideAllInventorySections();
            document.getElementById('inventory-list-view').classList.remove('hidden');
            loadInventory('list');
        };

        window.showAddProductForm = () => {
            hideAllInventorySections();
            document.getElementById('add-edit-view').classList.remove('hidden');
            document.getElementById('inventory-form').reset();
            document.getElementById('product-id').value = '';
            // Populate the segmento dropdown based on default rubro
            updateSegmentoDropdown();
            // Clear autocomplete suggestions
            hideAutocompleteSuggestions('producto');
            hideAutocompleteSuggestions('presentacion');
        };

        window.showModifyDeleteView = () => {
            hideAllInventorySections();
            document.getElementById('modify-delete-view').classList.remove('hidden');
            loadInventory('modify-delete');
        };

        window.showModifyQuantityView = () => {
            hideAllInventorySections();
            document.getElementById('modify-quantity-view').classList.remove('hidden');
            loadInventory('quantity');
        };

        window.backToMenu = () => {
            document.getElementById('main-menu').classList.remove('hidden');
            document.getElementById('inventory-section').classList.add('hidden');
            document.getElementById('sales-section').classList.add('hidden');
        };

        window.backToInventoryMenu = () => {
            hideAllInventorySections();
            document.getElementById('inventory-sub-menu').classList.remove('hidden');
        };

        // General Message Box
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            messageText.textContent = message;
            messageBox.className = 'absolute top-5 right-5 p-4 rounded-lg shadow-lg transition-transform transform translate-x-full';
            if (type === 'success') {
                messageBox.classList.add('bg-green-500', 'text-white');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-500', 'text-white');
            } else {
                messageBox.classList.add('bg-blue-500', 'text-white');
            }
            // Animate in
            setTimeout(() => {
                messageBox.classList.remove('translate-x-full');
            }, 10);
            // Animate out after 5 seconds
            setTimeout(() => {
                messageBox.classList.add('translate-x-full');
            }, 5000);
        }

        // Custom Confirmation Modal
        window.showConfirmationModal = (message, callback) => {
            const modal = document.getElementById('confirmation-modal');
            const modalMessage = document.getElementById('modal-message');
            const confirmBtn = document.getElementById('confirm-btn');
            const cancelBtn = document.getElementById('cancel-btn');

            modalMessage.textContent = message;
            modal.classList.remove('hidden');

            const onConfirm = () => {
                callback();
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', onConfirm);
                cancelBtn.removeEventListener('click', onCancel);
            };

            const onCancel = () => {
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', onConfirm);
                cancelBtn.removeEventListener('click', onCancel);
            };

            confirmBtn.addEventListener('click', onConfirm);
            cancelBtn.addEventListener('click', onCancel);
        };

        // Inventory Logic
        window.saveProduct = () => {
            if (!isAuthReady || !userId) {
                showMessage("El usuario no está listo para guardar datos. Por favor, espera y vuelve a intentarlo.", 'error');
                return;
            }
            
            const productId = document.getElementById('product-id').value;
            const message = productId ? "¿Estás seguro de que quieres modificar este producto?" : "¿Estás seguro de que quieres guardar este producto?";
            
            showConfirmationModal(message, async () => {
                const rubro = document.getElementById('rubro').value;
                const segmento = document.getElementById('segmento').value;
                const producto = document.getElementById('producto').value;
                const presentacion = document.getElementById('presentacion').value;
                const precio = parseFloat(document.getElementById('precio').value);
                const cantidad = parseInt(document.getElementById('cantidad').value, 10);
                const imagen = document.getElementById('imagen').value;

                if (!rubro || !segmento || !producto || !presentacion || isNaN(precio) || isNaN(cantidad)) {
                    showMessage("Por favor, completa todos los campos obligatorios.", 'error');
                    return;
                }

                const inventoryCollection = collection(db, `artifacts/${appId}/users/${userId}/inventory`);

                // Check for duplicates
                const q = query(inventoryCollection, 
                    where('rubro', '==', rubro),
                    where('segmento', '==', segmento),
                    where('producto', '==', producto),
                    where('presentacion', '==', presentacion)
                );
                const querySnapshot = await getDocs(q);

                let isDuplicate = false;
                querySnapshot.forEach(doc => {
                    // Check if a document with same characteristics exists and it's not the one we are editing
                    if (doc.id !== productId) {
                        isDuplicate = true;
                    }
                });

                if (isDuplicate) {
                    showMessage("Error: Ya existe un producto con estas mismas características.", 'error');
                    return;
                }

                const productData = {
                    rubro,
                    segmento,
                    producto,
                    presentacion,
                    precio,
                    cantidad,
                    imagen
                };

                try {
                    if (productId) {
                        await updateDoc(doc(inventoryCollection, productId), productData);
                        showMessage("Producto actualizado exitosamente.", 'success');
                    } else {
                        await addDoc(inventoryCollection, productData);
                        // Add the new product and presentation to the suggestion sets
                        productSuggestions.add(producto);
                        presentationSuggestions.add(presentacion);
                        showMessage("Producto guardado correctamente.", 'success');
                    }
                    document.getElementById('inventory-form').reset();
                    document.getElementById('product-id').value = '';
                } catch (e) {
                    console.error("Error al guardar el producto:", e);
                    showMessage("Error al guardar el producto.", 'error');
                }
            });
        };

        // Data for Segmento dropdown
        const segmentoOptions = {
            "Cerveceria": ["Obsequios", "Pilsen", "Ligth", "Soleras", "Sangrias y Vinos", "Vacio"],
            "P&M": ["Malta", "Pepsi/Golden", "Yukery", "Lipton", "Gatorade", "Minalva", "Soda", "Kina", "RockStar"],
            "Alimentos": ["Harina", "Arroz", "Pasta", "Mavesa", "Nelly", "Chef", "Pampero", "Rikesa", "Aceite", "Crema de Arroz", "Quaker", "Margarita", "Tody", "Konga", "Vinagre", "Las Llaves", "Antibacterial", "Multi Clean", "Mermelada", "Gelatina", "Migurt", "Gatos", "Perros"],
            "P&G": ["ACE", "Ariel", "Downy", "Always", "Rollon", "H&S", "Pantene S", "Pantene A", "Pantene", "Gillete", "Venus", "Oral B"]
        };

        // Function to update the Segmento dropdown based on the selected Rubro
        window.updateSegmentoDropdown = () => {
            const rubroSelect = document.getElementById('rubro');
            const segmentoSelect = document.getElementById('segmento');
            const selectedRubro = rubroSelect.value;

            // Clear existing options
            segmentoSelect.innerHTML = '<option value="">Seleccione Segmento</option>';

            // Enable/disable the dropdown based on rubro selection
            segmentoSelect.disabled = !selectedRubro;

            if (selectedRubro && segmentoOptions[selectedRubro]) {
                segmentoOptions[selectedRubro].forEach(segmento => {
                    const option = document.createElement('option');
                    option.value = segmento;
                    option.textContent = segmento;
                    segmentoSelect.appendChild(option);
                });
            }
        };

        window.editProduct = (productId, data) => {
            showAddProductForm(); // Navigate to the add product form to edit
            document.getElementById('product-id').value = productId;
            document.getElementById('rubro').value = data.rubro;
            // Update segmento dropdown with correct options before setting its value
            updateSegmentoDropdown();
            document.getElementById('segmento').value = data.segmento;
            document.getElementById('producto').value = data.producto;
            document.getElementById('presentacion').value = data.presentacion;
            document.getElementById('precio').value = data.precio;
            document.getElementById('cantidad').value = data.cantidad;
            document.getElementById('imagen').value = data.imagen;
            showMessage("Formulario cargado para editar.", 'info');
        };

        window.deleteProduct = (productId) => {
            showConfirmationModal("¿Estás seguro de que quieres eliminar este producto?", async () => {
                if (!userId) {
                    showMessage("Debes iniciar sesión para eliminar productos.", 'error');
                    return;
                }
                const inventoryCollection = collection(db, `artifacts/${appId}/users/${userId}/inventory`);
                try {
                    await deleteDoc(doc(inventoryCollection, productId));
                    showMessage("Producto eliminado exitosamente.", 'success');
                } catch (e) {
                    console.error("Error al eliminar el producto:", e);
                    showMessage("Error al eliminar el producto.", 'error');
                }
            });
        };

        window.updateQuantity = (productId) => {
            const newQuantity = parseInt(document.getElementById(`quantity-${productId}`).value, 10);
            showConfirmationModal("¿Estás seguro de que quieres actualizar la cantidad?", async () => {
                if (!userId) {
                    showMessage("Debes iniciar sesión para modificar la cantidad.", 'error');
                    return;
                }
                if (isNaN(newQuantity) || newQuantity < 0) {
                    showMessage("La cantidad debe ser un número válido.", 'error');
                    return;
                }
                const productRef = doc(db, `artifacts/${appId}/users/${userId}/inventory`, productId);
                try {
                    await updateDoc(productRef, { cantidad: newQuantity });
                    showMessage("Cantidad actualizada exitosamente.", 'success');
                } catch (e) {
                    console.error("Error al actualizar la cantidad:", e);
                    showMessage("Error al actualizar la cantidad.", 'error');
                }
            });
        };

        let unsubscribeFromInventory = null;

        function loadInventory(view) {
            if (!userId) {
                console.log("No hay usuario autenticado, no se puede cargar el inventario.");
                return;
            }
            
            // Unsubscribe from previous listener if it exists
            if (unsubscribeFromInventory) {
                unsubscribeFromInventory();
            }

            const inventoryCollection = collection(db, `artifacts/${appId}/users/${userId}/inventory`);
            
            unsubscribeFromInventory = onSnapshot(inventoryCollection, (snapshot) => {
                const products = [];
                snapshot.forEach(doc => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                if (view === 'list') {
                    renderProductsForList(products);
                }
                if (view === 'modify-delete') {
                    renderProductsForModifyDelete(products);
                }
                if (view === 'quantity') {
                    renderProductsForQuantity(products);
                }
            }, (error) => {
                console.error("Error al escuchar el inventario en tiempo real:", error);
                showMessage("Error al cargar el inventario.", 'error');
            });
        }

        function renderProductsForList(products) {
            const inventoryList = document.getElementById('inventory-list');
            inventoryList.innerHTML = '';
            
            if (products.length === 0) {
                inventoryList.innerHTML = '<p class="text-center text-gray-500">No hay productos en tu inventario.</p>';
            } else {
                const tableHtml = `
                    <div class="overflow-x-auto rounded-lg shadow-md">
                        <table class="w-full table-auto">
                            <thead>
                                <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Imagen</th>
                                    <th class="py-3 px-6 text-left">Producto</th>
                                    <th class="py-3 px-6 text-left">Presentación</th>
                                    <th class="py-3 px-6 text-left">Rubro</th>
                                    <th class="py-3 px-6 text-left">Segmento</th>
                                    <th class="py-3 px-6 text-left">Precio</th>
                                    <th class="py-3 px-6 text-left">Cantidad</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600 text-sm font-light">
                                ${products.map(product => `
                                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                                        <td class="py-3 px-6 text-left whitespace-nowrap">
                                            ${product.imagen ? `<img src="${product.imagen}" alt="${product.producto}" class="w-10 h-10 object-cover rounded-full">` : '<div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center text-gray-500 text-xs text-center">Sin imagen</div>'}
                                        </td>
                                        <td class="py-3 px-6 text-left">${product.producto}</td>
                                        <td class="py-3 px-6 text-left">${product.presentacion}</td>
                                        <td class="py-3 px-6 text-left">${product.rubro}</td>
                                        <td class="py-3 px-6 text-left">${product.segmento}</td>
                                        <td class="py-3 px-6 text-left">$${product.precio.toFixed(2)}</td>
                                        <td class="py-3 px-6 text-left">${product.cantidad}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                inventoryList.innerHTML = tableHtml;
            }
        }

        function renderProductsForModifyDelete(products) {
            const modifyDeleteList = document.getElementById('modify-delete-list');
            modifyDeleteList.innerHTML = '';
            if (products.length === 0) {
                modifyDeleteList.innerHTML = '<p class="text-center text-gray-500">No hay productos para modificar o eliminar.</p>';
            } else {
                products.forEach(product => {
                    const productDiv = document.createElement('div');
                    productDiv.className = 'bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0 sm:space-x-4';
                    productDiv.innerHTML = `
                        ${product.imagen ? `<img src="${product.imagen}" alt="${product.producto}" class="w-16 h-16 object-cover rounded-lg">` : '<div class="w-16 h-16 bg-gray-300 rounded-lg flex items-center justify-center text-gray-500 text-xs text-center">Sin imagen</div>'}
                        <div class="flex-1 text-center sm:text-left">
                            <p class="font-bold text-gray-800">${product.producto}</p>
                            <p class="text-sm text-gray-600">Rubro: ${product.rubro} - Segmento: ${product.segmento}</p>
                            <p class="text-sm text-gray-600">Presentación: ${product.presentacion}</p>
                            <p class="text-lg font-bold text-green-600">$${product.precio.toFixed(2)}</p>
                            <p class="text-sm text-gray-700">Cantidad: ${product.cantidad}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editProduct('${product.id}', ${JSON.stringify(product).replace(/'/g, "\\'")})" class="bg-yellow-500 text-white p-2 rounded-full hover:bg-yellow-600 transition duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                    <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button onclick="deleteProduct('${product.id}')" class="bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    modifyDeleteList.appendChild(productDiv);
                });
            }
        }
        
        function renderProductsForQuantity(products) {
            const quantityList = document.getElementById('quantity-list');
            quantityList.innerHTML = '';
            if (products.length === 0) {
                quantityList.innerHTML = '<p class="text-center text-gray-500">No hay productos en tu inventario.</p>';
            } else {
                products.forEach(product => {
                    const productDiv = document.createElement('div');
                    productDiv.className = 'bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0 sm:space-x-4';
                    productDiv.innerHTML = `
                        <div class="flex-1 text-center sm:text-left">
                            <p class="font-bold text-gray-800">${product.producto}</p>
                            <p class="text-sm text-gray-600">Presentación: ${product.presentacion}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="quantity-${product.id}" class="text-sm text-gray-600">Cantidad:</label>
                            <input type="number" id="quantity-${product.id}" value="${product.cantidad}" class="w-20 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="updateQuantity('${product.id}')" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path d="M10 2a8 8 0 100 16 8 8 0 000-16zM6 9a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z" />
                                </svg>
                            </button>
                        </div>
                    `;
                    quantityList.appendChild(productDiv);
                });
            }
        }
        
        // Autocomplete Logic
        async function loadSuggestions() {
            if (!userId) return;
            productSuggestions.clear();
            presentationSuggestions.clear();

            const inventoryCollection = collection(db, `artifacts/${appId}/users/${userId}/inventory`);
            const querySnapshot = await getDocs(inventoryCollection);
            
            querySnapshot.forEach(doc => {
                const data = doc.data();
                if (data.producto) productSuggestions.add(data.producto);
                if (data.presentacion) presentationSuggestions.add(data.presentacion);
            });
        }

        function filterAndShowSuggestions(inputId, suggestionsContainerId, suggestionsSet) {
            const input = document.getElementById(inputId);
            const container = document.getElementById(suggestionsContainerId);
            const value = input.value.toLowerCase();
            
            container.innerHTML = '';
            
            if (value.length === 0) {
                container.classList.add('hidden');
                return;
            }

            const filteredSuggestions = Array.from(suggestionsSet).filter(item => 
                item.toLowerCase().includes(value)
            ).sort();

            if (filteredSuggestions.length > 0) {
                container.classList.remove('hidden');
                filteredSuggestions.forEach(suggestion => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.textContent = suggestion;
                    suggestionItem.className = 'p-2 cursor-pointer hover:bg-gray-200';
                    suggestionItem.onclick = () => {
                        input.value = suggestion;
                        container.classList.add('hidden');
                    };
                    container.appendChild(suggestionItem);
                });
            } else {
                container.classList.add('hidden');
            }
        }

        function hideAutocompleteSuggestions(suggestionsContainerId) {
            document.getElementById(suggestionsContainerId + '-suggestions').classList.add('hidden');
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            const rubroSelect = document.getElementById('rubro');
            if (rubroSelect) {
                rubroSelect.addEventListener('change', updateSegmentoDropdown);
            }

            const productoInput = document.getElementById('producto');
            const presentacionInput = document.getElementById('presentacion');

            productoInput.addEventListener('input', () => filterAndShowSuggestions('producto', 'producto-suggestions', productSuggestions));
            productoInput.addEventListener('focus', () => filterAndShowSuggestions('producto', 'producto-suggestions', productSuggestions));
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#producto-container')) {
                    hideAutocompleteSuggestions('producto');
                }
            });

            presentacionInput.addEventListener('input', () => filterAndShowSuggestions('presentacion', 'presentacion-suggestions', presentationSuggestions));
            presentacionInput.addEventListener('focus', () => filterAndShowSuggestions('presentacion', 'presentacion-suggestions', presentationSuggestions));
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#presentacion-container')) {
                    hideAutocompleteSuggestions('presentacion');
                }
            });

            // Make sure the main app is initialized before we try to load suggestions
            if (auth.currentUser) {
                loadSuggestions();
            }
        });
    </script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <!-- Message Box -->
    <div id="message-box" class="fixed top-5 right-5 p-4 rounded-lg shadow-lg transition-transform duration-500 transform translate-x-full z-50">
        <p id="message-text"></p>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-bold mb-4 text-gray-800">Confirmación</h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition duration-300">No</button>
                <button id="confirm-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-300">Sí</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">

        <!-- Login Section -->
        <div id="login-container" class="space-y-4">
            <h1 class="text-3xl font-bold text-center text-gray-800">Iniciar Sesión</h1>
            <input type="email" id="email" placeholder="Correo Electrónico" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="password" id="password" placeholder="Contraseña" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="login()" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">Entrar</button>
            <button onclick="register()" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Registrarse</button>
        </div>

        <!-- Main Menu Section -->
        <div id="main-menu-container" class="hidden space-y-6">
            <div id="main-menu">
                <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Menú Principal</h1>
                <button onclick="showInventory()" class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-green-700 transition duration-300 mb-4">Inventario</button>
                <button onclick="showSales()" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Ventas</button>
            </div>

            <!-- Inventory Sub-section -->
            <div id="inventory-section" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Gestión de Inventario</h2>
                
                <div id="inventory-sub-menu" class="space-y-4">
                    <button onclick="showInventoryList()" class="w-full bg-gray-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-gray-700 transition duration-300">Ver Inventario</button>
                    <button onclick="showAddProductForm()" class="w-full bg-gray-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-gray-700 transition duration-300">Agregar Producto</button>
                    <button onclick="showModifyDeleteView()" class="w-full bg-gray-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-gray-700 transition duration-300">Modificar o Eliminar Producto</button>
                    <button onclick="showModifyQuantityView()" class="w-full bg-gray-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-gray-700 transition duration-300">Modificar Cantidad</button>
                    <button onclick="backToMenu()" class="w-full bg-gray-500 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-gray-600 transition duration-300">Regresar al Menú Principal</button>
                </div>
                
                <div id="inventory-list-view" class="hidden">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Lista de Productos</h3>
                    <div id="inventory-list" class="space-y-4">
                        <!-- Products will be dynamically added here -->
                    </div>
                    <button onclick="backToInventoryMenu()" class="w-full bg-gray-500 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-gray-600 transition duration-300 mt-6">Regresar al Menú de Inventario</button>
                </div>

                <div id="add-edit-view" class="hidden">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Agregar Producto</h3>
                    <form id="inventory-form" class="space-y-4 mb-8">
                        <input type="hidden" id="product-id">
                        <select id="rubro" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="">Seleccione Rubro</option>
                            <option value="Cerveceria">Cerveceria</option>
                            <option value="P&M">P&M</option>
                            <option value="Alimentos">Alimentos</option>
                            <option value="P&G">P&G</option>
                        </select>
                        <select id="segmento" disabled class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="">Seleccione Rubro primero</option>
                        </select>
                        
                        <div id="producto-container" class="relative">
                            <input type="text" id="producto" placeholder="Producto" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <div id="producto-suggestions" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-40 overflow-y-auto hidden"></div>
                        </div>

                        <div id="presentacion-container" class="relative">
                            <input type="text" id="presentacion" placeholder="Presentación" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <div id="presentacion-suggestions" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-40 overflow-y-auto hidden"></div>
                        </div>

                        <input type="number" id="precio" placeholder="Precio" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        <input type="number" id="cantidad" placeholder="Cantidad" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        <input type="url" id="imagen" placeholder="URL de la Imagen" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        <button type="button" onclick="saveProduct()" class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-green-700 transition duration-300">Guardar Producto</button>
                    </form>
                    <button onclick="backToInventoryMenu()" class="w-full bg-gray-500 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-gray-600 transition duration-300 mt-6">Regresar al Menú de Inventario</button>
                </div>

                <div id="modify-delete-view" class="hidden">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Modificar / Eliminar Producto</h3>
                    <div id="modify-delete-list" class="space-y-4">
                        <!-- Products with edit/delete buttons will be dynamically added here -->
                    </div>
                    <button onclick="backToInventoryMenu()" class="w-full bg-gray-500 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-gray-600 transition duration-300 mt-6">Regresar al Menú de Inventario</button>
                </div>

                <div id="modify-quantity-view" class="hidden">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Modificar Cantidad</h3>
                    <div id="quantity-list" class="space-y-4">
                        <!-- Products with quantity fields will be dynamically added here -->
                    </div>
                    <button onclick="backToInventoryMenu()" class="w-full bg-gray-500 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-gray-600 transition duration-300 mt-6">Regresar al Menú de Inventario</button>
                </div>
            </div>

            <!-- Sales Sub-section -->
            <div id="sales-section" class="hidden space-y-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Gestión de Ventas</h2>
                <!-- Sales functionality will go here -->
                <button onclick="backToMenu()" class="w-full bg-gray-500 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-gray-600 transition duration-300">Regresar al Menú</button>
            </div>
            
            <button onclick="logout()" class="w-full bg-red-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-red-700 transition duration-300 mt-6">Cerrar Sesión</button>
        </div>
    </div>
</body>
</html>
