<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dist Castillo Ventas</title>
    <!-- Ruta relativa para manifest.json -->
    <link rel="manifest" href="./manifest.json">
    <!-- Carga de Tailwind CSS desde CDN para asegurar que el estilo se aplique correctamente -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <!-- html2canvas para convertir HTML a imagen -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            /* Estilos para la imagen de fondo */
            background-image: url('./images/fondo.png'); /* Asegúrate de que la ruta sea correcta */
            background-size: cover; /* Cubre todo el viewport */
            background-position: center; /* Centra la imagen */
            background-repeat: no-repeat; /* Evita que la imagen se repita */
            background-attachment: fixed; /* Mantiene la imagen fija al hacer scroll */
            background-color: rgba(0, 0, 0, 0.1); /* Ligera capa oscura para mejorar contraste */
        }
        #app-root {
            width: 100%;
            max-width: 800px;
            background-color: rgba(255, 255, 255, 0.9); /* Fondo semi-transparente para app-root */
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding: 20px;
        }
        .screen-container {
            padding: 0px;
            width: 100%;
            /* Ajuste para que los contenedores de pantalla también sean semi-transparentes si se usan como fondo */
            background-color: rgba(255, 255, 255, 0.95); /* Un poco menos transparente que app-root */
            border-radius: 10px; /* Bordes redondeados para los contenedores internos */
            padding: 20px; /* Padding para el contenido de la pantalla */
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Fondo más oscuro para el modal */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: rgba(255, 255, 255, 0.98); /* Fondo casi opaco para el contenido del modal */
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            max-height: 90%;
            overflow-y: auto;
            text-align: center;
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
        }
        /* Estilos específicos de tabla */
        .table-container {
            overflow-x: auto; /* Permite desplazamiento horizontal en pantallas pequeñas */
            border-radius: 8px;
            border: 1px solid #e2e8f0; /* border-gray-200 */
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px 10px; /* Reducido el padding para hacer la tabla más compacta */
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* border-gray-200 */
        }
        th {
            background-color: #f8fafc; /* bg-gray-50 */
            font-weight: 600; /* font-semibold */
            color: #4a5568; /* text-gray-700 */
            text-transform: uppercase;
            font-size: 0.875rem; /* text-sm */
            letter-spacing: 0.05em;
        }
        tr:hover {
            background-color: #f0f4f8; /* hover:bg-gray-100 */
        }
        td input[type="number"] {
            width: 80px; /* Ancho fijo para la entrada de cantidad */
            padding: 6px 10px;
            border: 1px solid #cbd5e0; /* border-gray-300 */
            border-radius: 4px;
            text-align: center;
        }
        .radio-button-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        .radio-button-label {
            background-color: #e3f2fd; /* Azul claro */
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #1976d2; /* Azul */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            color: #1976d2; /* Azul */
            text-align: center;
        }
        .radio-button-label:hover {
            background-color: #bbdefb; /* Azul más claro al pasar el ratón */
        }
        .radio-button-input:checked + .radio-button-label {
            background-color: #1976d2; /* Azul */
            color: white;
            border-color: #0d47a1; /* Azul más oscuro */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .radio-button-input {
            display: none; /* Oculta el input de radio real */
        }

        /* Estilos para el recibo de impresora térmica */
        .thermal-receipt {
            font-family: 'monospace', 'Courier New', Courier, monospace; /* Fuente monoespaciada para simular impresora */
            font-size: 0.75rem; /* Tamaño de fuente pequeño */
            width: 250px; /* Ancho típico de un recibo térmico */
            margin: 0 auto;
            padding: 10px;
            border: 1px dashed #ccc; /* Borde punteado para simular corte */
            background-color: #fff;
            color: #000;
            text-align: left;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }
        .thermal-receipt h3, .thermal-receipt h4 {
            text-align: center;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }
        .thermal-receipt .item-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }
        .thermal-receipt .item-qty {
            width: 20%;
            text-align: left;
        }
        .thermal-receipt .item-desc {
            width: 50%;
            text-align: left;
        }
        .thermal-receipt .item-price, .item-total {
            width: 30%;
            text-align: right;
        }
        .thermal-receipt .divider {
            border-top: 1px dashed #000;
            margin: 5px 0;
        }
        .thermal-receipt .total-line {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-top: 5px;
            font-size: 0.9rem;
        }
        .thermal-receipt .footer-text {
            text-align: center;
            margin-top: 10px;
            font-size: 0.7rem;
        }

        /* Estilos para impresión (mantener para PC, aunque la lógica principal cambie) */
        @media print {
            body > *:not(.print-only) {
                display: none !important;
            }
            .print-only {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                margin: 0;
                padding: 0;
            }
            .thermal-receipt {
                border: none !important;
                box-shadow: none !important;
                width: 100% !important; /* Ajustar para ocupar el ancho de la página de impresión */
                font-size: 10pt; /* Ajustar el tamaño de la fuente para la impresión */
            }
        }
    </style>
</head>
<body>
    <div id="app-root"></div>

    <script>
        // --- Configuración de Firebase ---
        // Tu configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDLf4iOoqw0yecLPAMUkniHJTMF3YhRY7A",
            authDomain: "dist-castillo.firebaseapp.com",
            projectId: "dist-castillo",
            storageBucket: "dist-castillo.firebasestorage.app",
            messagingSenderId: "249846475959",
            appId: "1:249846475959:web:066c3fbca65ca39655af132",
            measurementId: "G-V56MBM5YT9"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); // Obtener la instancia de autenticación
        // const analytics = firebase.analytics(); // COMENTADO: Eliminar si no se usa activamente para evitar errores 404
        const db = firebase.firestore(); // Obtener la instancia de Firestore

        // Habilitar la persistencia offline de Firestore
        // Esto permite que la aplicación funcione sin conexión y sincronice los datos cuando se reconecte.
        // Las operaciones de escritura (add, set, update, delete) se ponen en cola localmente.
        firebase.firestore().enablePersistence()
            .then(() => {
                console.log("Persistencia offline de Firestore habilitada.");
            })
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    // Múltiples pestañas abiertas o Service Worker ya está usando la persistencia
                    console.warn("La persistencia offline no se pudo habilitar porque el navegador no la soporta o ya está en uso.");
                } else if (err.code == 'unimplemented') {
                    // El navegador actual no soporta la característica
                    console.warn("El navegador actual no soporta la persistencia offline de Firestore.");
                } else {
                    console.error("Error al habilitar la persistencia offline de Firestore:", err);
                }
            });


        // --- Datos de la aplicación (se cargarán desde Firestore) ---
        let clients = [];
        let inventory = []; // Inventario principal (almacén)
        let vendors = [];
        let dailySales = [];
        let vehicles = []; // NUEVO: Lista de vehículos/camiones
        let currentTruckInventory = []; // NUEVO: Inventario del camión actualmente asignado al usuario
        let users = []; // NUEVO: Lista de usuarios de la aplicación (para asignación de vehículos)
        let loadRecords = []; // NUEVO: Registros de carga de camiones
        let transferRecords = []; // NUEVO: Registros de transbordo de inventario entre camiones

        // Datos iniciales de ejemplo (se usarán para poblar Firestore si está vacío)
        const initialClients = [
            { id: '1', nombreComercial: 'Los Sartenes de Amita', nombrePersonal: 'Maria Rosario', zona: 'Foranea', sector: 'puerba cambio dos', tlf: '0414555555555', observaciones: 'al frente del chalet' },
            { id: '3', nombreComercial: 'El Parrandereo', nombrePersonal: 'Jose Martinez', zona: 'Santa Teresa', sector: 'Barrio Bolivar', tlf: '787878787878', observaciones: 'ninguna' },
            { id: '4', nombreComercial: 'Licoreria Grysyudey', nombrePersonal: 'Guillermina', zona: 'Palo Gordo', sector: 'Via Principal', tlf: '46898755675', observaciones: 'al doblar la esquina' },
        ];

        const initialInventory = [
            { rubro: 'Cerveceria', sku: '2364', segmento: 'cerveza', producto: 'solera verde', presentacion: '1/4', cantidad: 180, precio: 23 },
            { rubro: 'Cerveceria', sku: '7458', segmento: 'cerveza', producto: 'ligth', presentacion: '1/4', cantidad: 180, precio: 19.8 },
            { rubro: 'Alimentos', sku: '1001', segmento: 'panaderia', producto: 'pan de molde', presentacion: 'unidad', cantidad: 50, precio: 3.5 },
            { rubro: 'Alimentos', sku: '1002', segmento: 'lacteos', producto: 'leche entera', presentacion: 'litro', cantidad: 100, precio: 2.8 },
            { rubro: 'Cerveceria', sku: '9876', segmento: 'cerveza', producto: 'polar pilsen', presentacion: 'tercio', cantidad: 200, precio: 1.5 },
        ];

        const initialVendors = [
            { name: 'Wilfredo Chacon', category: 'Alimentos' },
            { name: 'Yonathan Chavez', category: 'Alimentos' },
            { name: 'Roberto Chacon', category: 'Cerveceria' },
        ];

        // NUEVO: Datos iniciales de vehículos
        const initialVehicles = [
            { plate: 'ABC-123', name: 'Volswaguen Worker 220', brand: 'Volswaguen', model: 'Worker 220' },
            { plate: 'DEF-456', name: 'Chevrolet FVR 300', brand: 'Chevrolet', model: 'FVR 300' },
            { plate: 'GHI-789', name: 'Chevrolet NPR 250', brand: 'Chevrolet', model: 'NPR 250' },
        ];


        // Establecer vendedor seleccionado inicial basado en localStorage o por defecto al primero si está disponible
        let selectedVendor = localStorage.getItem('selectedVendor') || (initialVendors.length > 0 ? initialVendors[0].name : 'Ninguno');

        // Mapeo de imágenes de productos apuntando a la carpeta local 'images/'
        const productImages = {
            '2364': './images/2364.png', // Solera
            '7458': './images/7458.png', // Ligth
            '1001': './images/1001.png', // Pan
            '1002': './images/1002.png', // Leche
            '9876': './images/9876.png', // Polar
            'default': './images/no-image.png' // Imagen por defecto
        };

        // --- Funciones de Ayuda ---
        const getCurrentDateFormatted = () => {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0'); // El mes es 0-indexado
            const year = today.getFullYear();
            return `${day}${month}${year}`;
        };

        // Función genérica para descargar contenido CSV
        const downloadCSV = (filename, csvContent) => {
            console.log(`[downloadCSV] Intentando descargar: ${filename}`);
            console.log(`[downloadCSV] Contenido CSV (primeras 200 chars): ${csvContent.substring(0, 200)}...`);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { // Detección de característica
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url); // Limpiar la URL del objeto
                console.log(`[downloadCSV] Descarga para ${filename} iniciada.`);
            } else {
                showMessageModal('La descarga de archivos no es compatible con este navegador.');
                console.error('[downloadCSV] La descarga de archivos no es compatible.');
            }
        };

        // Función genérica para parsear una cadena CSV a un array de objetos
        const parseCSV = (csvString) => {
            const lines = csvString.split('\n');
            const headers = lines[0].split(',').map(header => header.trim());
            const result = [];

            for (let i = 1; i < lines.length; i++) {
                const currentLine = lines[i].trim();
                if (currentLine === '') continue; // Saltar líneas vacías

                const data = currentLine.split(',');
                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j]] = data[j] ? data[j].trim() : '';
                }
                result.push(obj);
            }
            return result;
        };

        // Función genérica para convertir un array de objetos a una cadena CSV
        const toCSV = (data, headers) => {
            if (!data || data.length === 0) return '';

            const csvRows = [];
            const actualHeaders = headers || Object.keys(data[0]);
            csvRows.push(actualHeaders.join(','));

            for (const row of data) {
                const values = actualHeaders.map(header => {
                    const val = row[header];
                    // Manejar comas y comillas en los valores
                    if (typeof val === 'string' && (val.includes(',') || val.includes('"') || val.includes('\n'))) {
                        return `"${val.replace(/"/g, '""')}"`;
                    }
                    return val;
                    // Asegurarse de que los números se conviertan a cadena para evitar problemas con toFixed en CSV
                }).map(val => typeof val === 'number' ? val.toString() : val);
                csvRows.push(values.join(','));
            }
            return csvRows.join('\n');
        };

        // --- Estado Global de la Aplicación ---
        let screen = 'login';
        let newClient = { id: '', nombreComercial: '', nombrePersonal: '', zona: '', sector: '', tlf: '', observaciones: '' };
        let selectedClientForSale = null;
        let saleQuantities = {};
        let clientSearchTerm = ''; // Para el modal de selección de cliente en Venta
        let clientSearchTermClientes = ''; // Para el buscador en la pantalla de Clientes
        let showClientPickerModal = false;
        let currentProductIndex = 0;
        let showAddClientForm = false;

        // Estado global para el modal de mensajes
        let showMessageModalState = false;
        let messageModalText = '';

        // Estado global para el modal de confirmación
        let showConfirmationModalState = false;
        let confirmationModalMessage = '';
        let confirmationModalCallback = null;

        // Estado para el usuario autenticado de Firebase
        let currentUser = null;
        let currentUserData = { role: 'guest', assignedTruckPlate: null }; // Actualizado: incluye assignedTruckPlate

        const appRoot = document.getElementById('app-root');

        // Estado para la modificación de ventas
        let showModifySaleModalState = false;
        let selectedSaleForModification = null;
        let modifiedSaleQuantities = {};
        let modificationReason = '';

        // Estado para la pantalla de vehículos
        let editingVehicle = null; // Almacena el vehículo que se está editando

        // Estado para la carga de camiones (ahora recepción)
        let selectedTruckForReceiving = null;
        let selectedLoader = null;
        let receivingQuantities = {};
        let selectedTruckInventoryForReceiving = [];

        // NUEVO: Estado para la vista de inventario del admin
        let currentAdminInventoryView = 'main'; // 'main' o un 'plate' de camión
        let selectedAdminVehicleForInventory = null; // El vehículo seleccionado por el admin para ver su inventario

        // NUEVO: Estado para la pantalla de Reset Cargas Iniciales
        let resetQuantities = {};
        let allTruckInventories = {};

        // NUEVO: Estado para la función de Transbordo de Inventario
        let selectedDestinationTruck = null; // El camión de destino seleccionado para el transbordo
        let transferQuantities = {}; // Cantidades a transferir por SKU
        let transferPassword = ''; // Contraseña para transbordo

        // NUEVO: Estado para la edición de clientes
        let editingClient = null; // Almacena el cliente que se está editando
        let showEditClientModal = false; // Controla la visibilidad del modal de edición de cliente


        // --- Funciones de Rol ---
        const isAdmin = () => currentUserData.role === 'admin';
        const isUser = () => currentUserData.role === 'user'; // Simplificado para cualquier usuario no admin

        // Función para mostrar un modal de mensaje personalizado
        const showMessageModal = (message) => {
            messageModalText = message;
            showMessageModalState = true;
            render();
        };

        // Función para ocultar el modal de mensaje personalizado
        const hideMessageModal = () => {
            showMessageModalState = false;
            messageModalText = '';
            render();
        };

        // Función para renderizar el modal de mensaje
        const renderMessageModal = () => {
            if (!showMessageModalState) return;

            const modalDiv = document.createElement('div');
            modalDiv.id = 'custom-message-modal';
            modalDiv.className = 'modal';
            modalDiv.innerHTML = `
                <div class="modal-content">
                    <p class="text-lg text-center mb-4">${messageModalText}</p>
                    <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="hideMessageModal()">Cerrar</button>
                </div>
            `;
            appRoot.appendChild(modalDiv);
        };

        // --- Funciones para el Modal de Confirmación ---
        const showConfirmationModal = (message, callback) => {
            console.log('[showConfirmationModal] Mostrando modal de confirmación. Mensaje:', message);
            confirmationModalMessage = message;
            confirmationModalCallback = callback;
            showConfirmationModalState = true;
            render();
        };

        const hideConfirmationModal = (confirmed) => {
            console.log('[hideConfirmationModal] Ocultando modal de confirmación. Confirmado:', confirmed);
            showConfirmationModalState = false;
            if (confirmed && confirmationModalCallback) {
                console.log('[hideConfirmationModal] Ejecutando callback de confirmación.');
                confirmationModalCallback();
            }
            confirmationModalCallback = null;
            render();
        };

        const renderConfirmationModal = () => {
            if (!showConfirmationModalState) return;

            const modalDiv = document.createElement('div');
            modalDiv.id = 'confirmation-modal';
            modalDiv.className = 'modal';
            modalDiv.innerHTML = `
                <div class="modal-content">
                    <p class="text-lg text-center mb-6">${confirmationModalMessage}</p>
                    <div class="flex justify-around gap-4">
                        <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-5 rounded-lg flex-1 shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="hideConfirmationModal(true)">Confirmar</button>
                        <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg flex-1 shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="hideConfirmationModal(false)">Cancelar</button>
                    </div>
                </div>
            `;
            appRoot.appendChild(modalDiv);
        };

        // --- Lógica de Autenticación de Firebase ---

        // Función para registrar un nuevo usuario
        const handleRegister = async () => {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            if (!email || !password) {
                showMessageModal('Por favor, ingresa un correo electrónico y una contraseña.');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                const userDocRef = db.collection('users').doc(currentUser.uid);
                await userDocRef.set({
                    email: currentUser.email,
                    role: 'user', // Rol por defecto para nuevos registros
                    assignedTruckPlate: null, // Sin camión asignado por defecto
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                currentUserData = { email: currentUser.email, role: 'user', assignedTruckPlate: null };

                showMessageModal(`Registro exitoso para ${currentUser.email}! Tu rol es "user". Un administrador deberá asignarte un camión para que puedas realizar ventas.`);
                setScreenAndRender('main');
            } catch (error) {
                showMessageModal(`Error al registrar: ${error.message}`);
                console.error("Error al registrar:", error);
            }
        };

        // Función para iniciar sesión
        const handleLogin = async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showMessageModal('Por favor, ingresa tu correo electrónico y contraseña.');
                return;
            }

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                // onAuthStateChanged se encargará de cargar los datos del usuario y redirigir
            } catch (error) {
                showMessageModal(`Error al iniciar sesión: ${error.message}`);
                console.error("Error al iniciar sesión:", error);
            }
        };

        // Función para cerrar sesión
        const handleLogout = async () => {
            try {
                await auth.signOut();
                currentUser = null;
                currentUserData = { role: 'guest', assignedTruckPlate: null }; // Reiniciar datos de usuario al cerrar sesión
                showMessageModal('Sesión cerrada correctamente.');
                setScreenAndRender('login');
            } catch (error) {
                showMessageModal(`Error al cerrar sesión: ${error.message}`);
                console.error("Error al cerrar sesión:", error);
            }
        };

        // Observar el estado de autenticación de Firebase
        auth.onAuthStateChanged(async (user) => {
            console.log('Estado de autenticación de Firebase cambiado. Usuario:', user ? user.email : 'Ninguno');
            if (user) {
                currentUser = user;
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        currentUserData = userDoc.data();
                        console.log('[Firestore] Perfil de usuario cargado:', currentUserData);
                    } else {
                        // Si el documento del usuario no existe, crearlo con rol 'user' y sin camión asignado
                        console.warn('[Firestore] Documento de usuario no encontrado. Creando uno con rol "user" y sin camión asignado.');
                        await db.collection('users').doc(user.uid).set({
                            email: user.email,
                            role: 'user',
                            assignedTruckPlate: null,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        currentUserData = { email: user.email, role: 'user', assignedTruckPlate: null };
                    }
                } catch (error) {
                    console.error('[Firestore] Error al cargar el perfil del usuario:', error);
                    showMessageModal('Error al cargar tu perfil. Algunas funciones pueden estar limitadas.');
                    currentUserData = { role: 'user', assignedTruckPlate: null }; // Fallback a rol de usuario normal
                }

                // Cargar datos de Firestore (clientes, inventario, etc.) después de obtener el rol
                await fetchDataFromFirestore();

                if (screen === 'login' || screen === 'register') {
                    setScreenAndRender('main');
                } else {
                    render();
                }
            } else {
                currentUser = null;
                currentUserData = { role: 'guest', assignedTruckPlate: null }; // No hay usuario, rol de invitado
                clients = [];
                inventory = [];
                vendors = [];
                dailySales = [];
                vehicles = [];
                currentTruckInventory = []; // Limpiar inventario del camión
                users = []; // Limpiar lista de usuarios
                loadRecords = []; // Limpiar registros de carga
                transferRecords = []; // Limpiar registros de transbordo
                if (screen !== 'login' && screen !== 'register') {
                    setScreenAndRender('login');
                } else {
                    render();
                }
            }
        });

        // --- Funciones de Carga de Datos desde Firestore ---
        const fetchDataFromFirestore = async () => {
            console.log('[Firestore] Intentando cargar datos...');
            try {
                // Cargar Clientes
                const clientsSnapshot = await db.collection('clients').get();
                if (clientsSnapshot.empty) {
                    console.log('[Firestore] Colección "clients" vacía. Poblando con datos iniciales.');
                    for (const client of initialClients) {
                        await db.collection('clients').doc(client.id).set(client);
                    }
                    clients = initialClients;
                } else {
                    clients = clientsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                console.log('[Firestore] Clientes cargados:', clients);

                // Cargar Inventario Principal (Almacén)
                const inventorySnapshot = await db.collection('inventory').get();
                if (inventorySnapshot.empty) {
                    console.log('[Firestore] Colección "inventory" vacía. Poblando con datos iniciales.');
                    for (const item of initialInventory) {
                        await db.collection('inventory').doc(item.sku).set(item);
                    }
                    inventory = initialInventory;
                } else {
                    inventory = inventorySnapshot.docs.map(doc => ({ sku: doc.id, ...doc.data() }));
                }
                console.log('[Firestore] Inventario principal cargado:', inventory);

                // Cargar Vendedores
                const vendorsSnapshot = await db.collection('vendors').get();
                if (vendorsSnapshot.empty) {
                    console.log('[Firestore] Colección "vendors" vacía. Poblando con datos iniciales.');
                    for (const vendor of initialVendors) {
                        await db.collection('vendors').doc(vendor.name.replace(/\s/g, '_')).set(vendor);
                    }
                    vendors = initialVendors;
                } else {
                    vendors = vendorsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                console.log('[Firestore] Vendedores cargados:', vendors);

                // Cargar Vehículos (Camiones)
                const vehiclesSnapshot = await db.collection('vehicles').get();
                if (vehiclesSnapshot.empty) {
                    console.log('[Firestore] Colección "vehicles" vacía. Poblando con datos iniciales y creando inventarios de camiones.');
                    for (const vehicle of initialVehicles) {
                        await db.collection('vehicles').doc(vehicle.plate).set(vehicle);
                        // Crear un documento de inventario vacío para cada camión
                        await db.collection('truck_inventories').doc(vehicle.plate).set({ items: [] });
                    }
                    vehicles = initialVehicles;
                } else {
                    vehicles = vehiclesSnapshot.docs.map(doc => ({ plate: doc.id, ...doc.data() }));
                }
                console.log('[Firestore] Vehículos cargados:', vehicles);

                // Cargar Usuarios (para asignación de vehículos)
                const usersSnapshot = await db.collection('users').get();
                users = usersSnapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
                console.log('[Firestore] Usuarios cargados:', users);


                // Cargar Inventario del Camión Asignado (si aplica)
                if (currentUserData.assignedTruckPlate) {
                    console.log(`[Firestore] Cargando inventario para el camión asignado: ${currentUserData.assignedTruckPlate}`);
                    const truckInventoryDoc = await db.collection('truck_inventories').doc(currentUserData.assignedTruckPlate).get();
                    if (truckInventoryDoc.exists) {
                        currentTruckInventory = truckInventoryDoc.data().items || [];
                        console.log('[Firestore] Inventario del camión cargado:', currentTruckInventory);
                    } else {
                        console.warn(`[Firestore] No se encontró inventario para el camión ${currentUserData.assignedTruckPlate}. Creando uno vacío.`);
                        await db.collection('truck_inventories').doc(currentUserData.assignedTruckPlate).set({ items: [] });
                        currentTruckInventory = [];
                    }
                } else {
                    currentTruckInventory = []; // No hay camión asignado, no hay inventario de camión
                    console.log('[Firestore] No hay camión asignado al usuario.');
                }

                // Cargar Ventas Diarias
                const dailySalesSnapshot = await db.collection('dailySales').get();
                dailySales = dailySalesSnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                console.log('[Firestore] Ventas diarias cargadas:', dailySales);

                // Cargar Registros de Carga (solo si es admin)
                if (isAdmin()) {
                    const loadRecordsSnapshot = await db.collection('loadRecords').get();
                    loadRecords = loadRecordsSnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                    console.log('[Firestore] Registros de carga cargados (Admin):', loadRecords);
                } else {
                    loadRecords = []; // Asegurarse de que esté vacío para usuarios normales
                    console.log('[Firestore] No se cargan registros de carga para usuarios normales.');
                }

                // Cargar Registros de Transbordo (filtrado por usuario si es user, todos si es admin)
                if (isAdmin()) {
                    const transferRecordsSnapshot = await db.collection('transferRecords').get();
                    transferRecords = transferRecordsSnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                    console.log('[Firestore] Registros de transbordo cargados (Admin):', transferRecords);
                } else if (isUser() && currentUser) {
                    // Para usuarios normales, solo cargar sus propios registros de transbordo
                    const userTransferRecordsSnapshot = await db.collection('transferRecords').where('userId', '==', currentUser.uid).get();
                    transferRecords = userTransferRecordsSnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                    console.log('[Firestore] Registros de transbordo cargados (User):', transferRecords);
                } else {
                    transferRecords = []; // Asegurarse de que esté vacío si no hay usuario o no es admin/user
                    console.log('[Firestore] No se cargan registros de transbordo.');
                }


                // Actualizar el vendedor seleccionado si el anterior no existe
                if (!vendors.some(v => v.name === selectedVendor)) {
                    selectedVendor = vendors.length > 0 ? vendors[0].name : 'Ninguno';
                    localStorage.setItem('selectedVendor', selectedVendor);
                }

            } catch (error) {
                console.error('[Firestore] Error al cargar datos de Firestore:', error);
                showMessageModal('Error al cargar datos. Usando datos de ejemplo. Por favor, revisa tu conexión y las reglas de seguridad de Firestore.');
                // Fallback a datos iniciales si hay un error al cargar
                clients = initialClients;
                inventory = initialInventory;
                vendors = initialVendors;
                vehicles = initialVehicles; // Fallback para vehículos
                dailySales = [];
                currentTruckInventory = [];
                users = [];
                loadRecords = [];
                transferRecords = [];
            } finally {
                render(); // Asegurarse de renderizar la UI después de cargar los datos
            }
        };

        // --- Función Principal de Renderizado ---
        const render = () => {
            // Limpia todo el contenido anterior de forma más explícita
            while (appRoot.firstChild) {
                appRoot.removeChild(appRoot.firstChild);
            }
            // console.log('[render] appRoot.childNodes han sido eliminados.'); // Para depuración

            if (!currentUser && screen !== 'login' && screen !== 'register') {
                renderLoginScreen();
            } else {
                switch (screen) {
                    case 'main':
                        renderMainScreen();
                        break;
                    case 'cargaSelection':
                        renderCargaSelectionScreen();
                        break;
                    case 'truckLoading':
                        renderTruckReceivingScreen();
                        break;
                    case 'loadHistory':
                        renderLoadHistoryScreen();
                        break;
                    case 'inventario':
                        renderInventarioScreen();
                        break;
                    case 'clientes':
                        renderClientesScreen();
                        break;
                    case 'venta':
                        renderVentaScreen();
                        break;
                    case 'cierreVentas':
                        renderCierreVentasScreen();
                        break;
                    case 'archivosAdmin':
                        renderArchivosAdminScreen();
                        break;
                    case 'archivosVenta':
                        renderArchivosVentaScreen();
                        break;
                    case 'vehicles':
                        renderVehiclesScreen();
                        break;
                    case 'adminInventorySelection':
                        renderAdminInventorySelection();
                        break;
                    case 'adminVehicleInventory':
                        renderAdminVehicleInventoryScreen();
                        break;
                    case 'assignVehicle':
                        renderAssignVehicleScreen();
                        break;
                    case 'login':
                        renderLoginScreen();
                        break;
                    case 'register':
                        renderRegisterScreen();
                        break;
                    case 'resetCargasInicialesPassword':
                        renderResetCargasInicialesPasswordScreen();
                        break;
                    case 'resetCargasInicialesEdit':
                        renderResetCargasInicialesEditScreen();
                        break;
                    case 'transferInventoryPassword':
                        renderTransferInventoryPasswordScreen();
                        break;
                    case 'transferInventory':
                        renderTransferInventoryScreen();
                        break;
                    case 'adminTransferHistory':
                        renderAdminTransferHistoryScreen();
                        break;
                    default:
                        renderMainScreen();
                }
            }
            renderMessageModal();
            renderConfirmationModal();
            if (showModifySaleModalState) {
                renderModifySaleModal();
            }
        };

        // --- Pantallas / Componentes ---

        const renderLoginScreen = () => {
            const loginDiv = document.createElement('div');
            loginDiv.className = 'screen-container bg-white rounded-xl shadow-md p-8 max-w-md mx-auto my-10';
            loginDiv.innerHTML = `
                <h2 class="text-3xl font-bold mb-6 text-center text-indigo-700">Iniciar Sesión</h2>
                <input type="email" id="loginEmail" class="h-12 border border-gray-300 rounded-lg px-4 mb-4 text-base w-full bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Correo Electrónico">
                <input type="password" id="loginPassword" class="h-12 border border-gray-300 rounded-lg px-4 mb-6 text-base w-full bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Contraseña">
                <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="handleLogin()">Iniciar Sesión</button>
                <p class="text-center mt-6 text-gray-700">¿No tienes cuenta? <a href="#" class="text-indigo-600 hover:underline font-semibold" onclick="setScreenAndRender('register')">Regístrate aquí</a></p>
            `;
            appRoot.appendChild(loginDiv);
        };

        const renderRegisterScreen = () => {
            const registerDiv = document.createElement('div');
            registerDiv.className = 'screen-container bg-white rounded-xl shadow-md p-8 max-w-md mx-auto my-10';
            registerDiv.innerHTML = `
                <h2 class="text-3xl font-bold mb-6 text-center text-indigo-700">Registrar Nuevo Usuario</h2>
                <input type="email" id="registerEmail" class="h-12 border border-gray-300 rounded-lg px-4 mb-4 text-base w-full bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Correo Electrónico">
                <input type="password" id="registerPassword" class="h-12 border border-gray-300 rounded-lg px-4 mb-6 text-base w-full bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Contraseña">
                <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="handleRegister()">Registrar</button>
                <p class="text-center mt-6 text-gray-700">¿Ya tienes cuenta? <a href="#" class="text-indigo-600 hover:underline font-semibold" onclick="setScreenAndRender('login')">Inicia sesión aquí</a></p>
            `;
            appRoot.appendChild(registerDiv);
        };


        const renderMainScreen = () => {
            const mainDiv = document.createElement('div');
            mainDiv.className = 'flex flex-col items-center justify-center p-5 bg-blue-50 rounded-xl m-2 shadow-lg';
            mainDiv.innerHTML = `
                <h1 class="text-3xl font-bold mb-4 text-indigo-700 drop-shadow-sm">Dist Castillo Ventas</h1>
                ${currentUser ? `<p class="text-md text-gray-700 mb-4">Bienvenido, ${currentUser.email} (${currentUserData.role}) ${currentUserData.assignedTruckPlate ? ` - Camión: ${currentUserData.assignedTruckPlate}` : ''}</p>` : ''}
                <div class="flex flex-wrap justify-center">
                    ${isAdmin() ? `<button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg m-2 min-w-[150px] shadow-md transition duration-300 ease-in-out transform hover:scale-105 border border-indigo-700" onclick="setScreenAndRender('cargaSelection')">CARGA</button>` : ''}
                    ${isAdmin() ? `<button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg m-2 min-w-[150px] shadow-md transition duration-300 ease-in-out transform hover:scale-105 border border-indigo-700" onclick="setScreenAndRender('adminInventorySelection')">INVENTARIO</button>` : ''}
                    ${isUser() ? `<button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg m-2 min-w-[150px] shadow-md transition duration-300 ease-in-out transform hover:scale-105 border border-indigo-700" onclick="setScreenAndRender('inventario')">INVENTARIO</button>` : ''}
                    <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg m-2 min-w-[150px] shadow-md transition duration-300 ease-in-out transform hover:scale-105 border border-indigo-700" onclick="setScreenAndRender('clientes')">CLIENTES</button>
                    ${isUser() ? `<button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg m-2 min-w-[150px] shadow-md transition duration-300 ease-in-out transform hover:scale-105 border border-indigo-700" onclick="setScreenAndRender('venta')">VENTA</button>` : ''}
                    ${isUser() ? `<button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg m-2 min-w-[150px] shadow-md transition duration-300 ease-in-out transform hover:scale-105 border border-indigo-700" onclick="setScreenAndRender('cierreVentas')">CIERRE VENTAS</button>` : ''}
                    ${isAdmin() ? `<button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg m-2 min-w-[150px] shadow-md transition duration-300 ease-in-out transform hover:scale-105 border border-indigo-700" onclick="setScreenAndRender('archivosAdmin')">ARCHIVOS ADMIN</button>` : ''}
                    ${!isAdmin() && currentUser ? `<button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg m-2 min-w-[150px] shadow-md transition duration-300 ease-in-out transform hover:scale-105 border border-indigo-700" onclick="setScreenAndRender('archivosVenta')">ARCHIVOS DE VENTA</button>` : ''}
                    ${isAdmin() ? `<button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg m-2 min-w-[150px] shadow-md transition duration-300 ease-in-out transform hover:scale-105 border border-indigo-700" onclick="setScreenAndRender('vehicles')">VEHÍCULOS DE CARGA</button>` : ''}
                    ${isAdmin() ? `<button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg m-2 min-w-[150px] shadow-md transition duration-300 ease-in-out transform hover:scale-105 border border-indigo-700" onclick="setScreenAndRender('assignVehicle')">ASIGNAR VEHÍCULO</button>` : ''}
                    ${isUser() ? `<button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg m-2 min-w-[150px] shadow-md transition duration-300 ease-in-out transform hover:scale-105 border border-indigo-700" onclick="setScreenAndRender('transferInventoryPassword')">TRANSBORDO INV.</button>` : ''}
                    ${isAdmin() ? `<button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg m-2 min-w-[150px] shadow-md transition duration-300 ease-in-out transform hover:scale-105 border border-indigo-700" onclick="setScreenAndRender('adminTransferHistory')">HISTORIAL TRANSBORDOS</button>` : ''}
                </div>
                <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg mt-8 shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="handleLogout()">Cerrar Sesión</button>
            `;
            appRoot.appendChild(mainDiv);
        };

        const updateVendorSelectionDisplay = () => {
            const vendorRadioGroup = document.getElementById('vendor-radio-group');
            if (!vendorRadioGroup) return;

            vendorRadioGroup.innerHTML = '';

            vendors.forEach(vendor => {
                const input = document.createElement('input');
                input.type = 'radio';
                input.id = `vendor-${vendor.name.replace(/\s/g, '-')}`;
                input.name = 'vendor';
                input.value = vendor.name;
                input.className = 'radio-button-input';
                input.checked = (selectedVendor === vendor.name);
                input.onchange = (event) => handleVendorChange(event.target.value);

                const label = document.createElement('label');
                label.htmlFor = `vendor-${vendor.name.replace(/\s/g, '-')}`;
                label.className = 'radio-button-label';
                label.textContent = vendor.name;

                vendorRadioGroup.appendChild(input);
                vendorRadioGroup.appendChild(label);
            });
        };

        const handleVendorChange = (vendorName) => {
            selectedVendor = vendorName;
            localStorage.setItem('selectedVendor', selectedVendor);
        };

        const renderCierreVentasScreen = () => {
            // Removido el check isAdmin() aquí para permitir acceso a todos los usuarios autenticados
            const cierreDiv = document.createElement('div');
            cierreDiv.className = 'screen-container bg-white rounded-xl m-2 shadow-md';
            cierreDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-5 text-center text-indigo-700">CIERRE DE VENTAS</h2>
                <div class="mb-8 text-center">
                    <label class="block text-lg font-semibold text-gray-700 mb-2">Seleccionar Vendedor:</label>
                    <div class="radio-button-group" id="vendor-radio-group">
                        <!-- Los botones de radio del vendedor se insertarán aquí por updateVendorSelectionDisplay() -->
                    </div>
                </div>
                <p class="text-base text-center my-5 text-gray-600">
                    Esta sección permite consolidar y cerrar las ventas del día.
                </p>
                <button class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-5 rounded-lg mt-3 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="showCloseSalesConfirmation()">Cerrar Ventas del Día</button>
                <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg mt-5 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('main')">Volver</button>
            `;
            appRoot.appendChild(cierreDiv);
            updateVendorSelectionDisplay();
        };

        const showCloseSalesConfirmation = () => {
            // Ya no hay check de isAdmin() aquí, todos los usuarios autenticados pueden cerrar ventas
            console.log('[showCloseSalesConfirmation] Llamado.');
            showConfirmationModal('¿Estás seguro de que quieres cerrar las ventas del día? Esto consolidará las ventas y "borrará" los registros individuales.', handleCloseSalesLogic);
        };

        const handleCloseSalesLogic = async () => {
            console.log('[handleCloseSalesLogic] Iniciando...');
            let messages = [];

            if (dailySales.length === 0) {
                showMessageModal('No hay Ventas: No hay ventas registradas para cerrar.');
                console.warn('[handleCloseSalesLogic] Advertencia: No hay ventas para cerrar.');
                return;
            }

            // Group sales by date
            const salesByDate = {};
            dailySales.forEach(sale => {
                if (!salesByDate[sale.date]) {
                    salesByDate[sale.date] = [];
                }
                salesByDate[sale.date].push(sale);
            });

            let allProcessedSaleDocIds = [];
            let updatedMainInventory = JSON.parse(JSON.stringify(inventory)); // Start with a fresh copy of current inventory

            // Process sales for each date
            for (const date in salesByDate) {
                const salesForThisDate = salesByDate[date];

                // --- Aggregation logic for this date (by SKU) ---
                const aggregatedSalesBySku = {};
                let totalOverallSale = 0;
                salesForThisDate.forEach(sale => {
                    sale.items.forEach(item => {
                        const { sku, producto, presentacion, cantidadVendida, precioUnitario, subtotal } = item;
                        if (!aggregatedSalesBySku[sku]) {
                            aggregatedSalesBySku[sku] = {
                                producto: producto,
                                presentacion: presentacion,
                                totalCantidad: 0,
                                totalSubtotal: 0
                            };
                        }
                        aggregatedSalesBySku[sku].totalCantidad += cantidadVendida;
                        aggregatedSalesBySku[sku].totalSubtotal += subtotal;
                        totalOverallSale += subtotal;
                    });
                });

                // Generate combined CSV by SKU
                let combinedCSVContent = `Venta General Consolidada - Fecha: ${date}\n`;
                combinedCSVContent += `Vendedor: ${selectedVendor}\n\n`;
                combinedCSVContent += `SKU,Producto,Presentacion,Cantidad Total,Subtotal Total\n`;
                for (const sku in aggregatedSalesBySku) {
                    const item = aggregatedSalesBySku[sku];
                    combinedCSVContent += `${sku},${item.producto},${item.presentacion},${item.totalCantidad},${item.totalSubtotal.toFixed(2)}\n`;
                }
                combinedCSVContent += `\nTotal General:, , , ,${totalOverallSale.toFixed(2)}`;
                const combinedFileName = `venta_consolidada_${date}.csv`;
                messages.push(`Cierre de Ventas para ${date}: Se ha generado el archivo "${combinedFileName}" con las ventas consolidadas.\nTotal del día: $${totalOverallSale.toFixed(2)}`);
                downloadCSV(combinedFileName, combinedCSVContent);

                // --- Aggregation logic for this date (by Client) ---
                const uniqueSKUs = new Set();
                const clientSalesData = {};
                salesForThisDate.forEach(sale => {
                    if (!clientSalesData[sale.client.id]) {
                        clientSalesData[sale.client.id] = {
                            clientName: sale.client.nombreComercial,
                            total: 0,
                            skus: {}
                        };
                    }
                    sale.items.forEach(item => {
                        uniqueSKUs.add(item.sku);
                        clientSalesData[sale.client.id].skus[item.sku] =
                            (clientSalesData[sale.client.id].skus[item.sku] || 0) + item.cantidadVendida;
                        clientSalesData[sale.client.id].total += item.subtotal;
                    });
                });
                const sortedUniqueSKUs = Array.from(uniqueSKUs).sort();
                let clientCSVContent = `Venta General por Clientes - Fecha: ${date}\n`;
                clientCSVContent += `Vendedor: ${selectedVendor}\n\n`;
                clientCSVContent += `Cliente,${sortedUniqueSKUs.map(sku => `SKU(${sku})`).join(',')},Total\n`;
                let grandTotalClients = 0;
                for (const clientId in clientSalesData) {
                    const clientData = clientSalesData[clientId];
                    let clientRow = `"${clientData.clientName}"`;
                    sortedUniqueSKUs.forEach(sku => {
                        clientRow += `,${clientData.skus[sku] || 0}`;
                    });
                    clientRow += `,${clientData.total.toFixed(2)}\n`;
                    clientCSVContent += clientRow;
                    grandTotalClients += clientData.total;
                }
                clientCSVContent += `Total General:,${','.repeat(sortedUniqueSKUs.length)},${grandTotalClients.toFixed(2)}`;
                const clientFileName = `ventas_por_cliente_${date}.csv`;
                messages.push(`Se ha generado el archivo "${clientFileName}" con las ventas consolidadas por cliente para ${date}.`);
                downloadCSV(clientFileName, clientCSVContent);

                // --- Deduct aggregated sales from Main Warehouse Inventory for THIS DATE ---
                for (const sku in aggregatedSalesBySku) {
                    const totalQuantitySold = aggregatedSalesBySku[sku].totalCantidad;
                    const mainInventoryItem = updatedMainInventory.find(item => item.sku === sku);

                    if (mainInventoryItem) {
                        mainInventoryItem.cantidad = Math.max(0, mainInventoryItem.cantidad - totalQuantitySold);
                        console.log(`[handleCloseSalesLogic] SKU ${sku} for date ${date}: Old quantity: ${mainInventoryItem.cantidad + totalQuantitySold}, Sold: ${totalQuantitySold}, New quantity: ${mainInventoryItem.cantidad}`);
                    } else {
                        console.warn(`[handleCloseSalesLogic] SKU ${sku} sold (${totalQuantitySold} units) for date ${date} not found in main inventory for deduction. Possibly a new product or an SKU error.`);
                    }
                }

                // Collect docIds for deletion for this date
                salesForThisDate.forEach(sale => {
                    if (sale.docId) {
                        allProcessedSaleDocIds.push(sale.docId);
                    }
                });
            } // End of loop for each date

            messages.push(`Compartiendo: Simulando compartir archivos de cierre vía WhatsApp.`);
            messages.push(`Imprimiendo: Simulando impresión del cierre de ventas.`);

            try {
                // Use a batch for atomic updates
                const batch = db.batch();

                // Actualizar el inventario del almacén principal en Firestore con las cantidades finales deducidas
                for (const item of updatedMainInventory) {
                    const itemRef = db.collection('inventory').doc(item.sku);
                    batch.set(itemRef, item); // Usar set para sobrescribir o crear si no existe
                }
                // Actualizar el estado local del inventario principal
                inventory = updatedMainInventory;
                console.log('[Firestore] Inventario principal actualizado localmente después del cierre de ventas.');

                // Eliminar registros de ventas individuales de Firestore que fueron procesados
                for (const docId of allProcessedSaleDocIds) {
                    const saleRef = db.collection('dailySales').doc(docId);
                    batch.delete(saleRef);
                }
                // Actualizar el estado local de dailySales
                dailySales = dailySales.filter(sale => !allProcessedSaleDocIds.includes(sale.docId));
                console.log('[Firestore] Ventas diarias procesadas eliminadas localmente.');

                await batch.commit(); // Confirmar todas las operaciones del batch
                console.log('[Firestore] Todas las operaciones del cierre de ventas (inventario principal y eliminación de ventas) confirmadas en Firestore.');
                messages.push('Inventario Principal Actualizado: Las ventas han sido deducidas del inventario principal.');
                messages.push('Archivos Borrados: Los archivos de ventas individuales procesados han sido "borrados" de Firestore.');
            } catch (error) {
                console.error('Error al actualizar inventario principal o eliminar ventas diarias de Firestore:', error);
                messages.push('Error al procesar el cierre de ventas. Por favor, revisa tu conexión y las reglas de seguridad.');
            }

            setScreenAndRender('main');
            showMessageModal(messages.join('\n'));
            console.log('[handleCloseSalesLogic] Finalizado.');
        };

        const generateThermalReceiptHtml = (saleRecord) => {
            let itemsHtml = '';
            saleRecord.items.forEach(item => {
                itemsHtml += `
                    <div class="item-row">
                        <span class="item-qty">${item.cantidadVendida}x</span>
                        <span class="item-desc">${item.producto} (${item.presentacion})</span>
                        <span class="item-price">$${item.precioUnitario.toFixed(2)}</span>
                        <span class="item-total">$${item.subtotal.toFixed(2)}</span>
                    </div>
                `;
            });

            let modificationReasonHtml = '';
            if (saleRecord.modificationReason) {
                modificationReasonHtml = `
                    <div style="border-top: 1px dashed #000; margin: 5px 0;"></div>
                    <p style="font-weight: bold;">Motivo Modificación:</p>
                    <p>${saleRecord.modificationReason}</p>
                `;
            }

            return `
                <div style="font-family: 'monospace', 'Courier New', Courier, monospace; font-size: 0.75rem; width: 250px; margin: 0 auto; padding: 10px; border: 1px dashed #ccc; background-color: #fff; color: #000; text-align: left; box-shadow: 0 0 5px rgba(0,0,0,0.1);">
                    <h3 style="text-align: center; margin-bottom: 5px; font-size: 0.85rem;">Dist Castillo Ventas</h3>
                    <h4 style="text-align: center; margin-bottom: 5px; font-size: 0.85rem;">Recibo de Venta</h4>
                    <div style="border-top: 1px dashed #000; margin: 5px 0;"></div>
                    <p>Fecha: ${saleRecord.date}</p>
                    <p>Cliente: ${saleRecord.client.nombreComercial}</p>
                    <p>Vendedor: ${saleRecord.vendor || selectedVendor}</p> <!-- Usar el vendedor de la venta si existe, sino el seleccionado -->
                    <div style="border-top: 1px dashed #000; margin: 5px 0;"></div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                        <span style="width: 20%; text-align: left;">Cant.</span>
                        <span style="width: 50%; text-align: left;">Producto</span>
                        <span style="width: 30%; text-align: right;">Total</span>
                    </div>
                    <div style="border-top: 1px dashed #000; margin: 5px 0;"></div>
                    ${itemsHtml}
                    <div style="border-top: 1px dashed #000; margin: 5px 0;"></div>
                    <div style="display: flex; justify-content: space-between; font-weight: bold; margin-top: 5px; font-size: 0.9rem;">
                        <span>TOTAL:</span>
                        <span>$${saleRecord.total.toFixed(2)}</span>
                    </div>
                    ${modificationReasonHtml}
                    <div style="border-top: 1px dashed #000; margin: 5px 0;"></div>
                    <p style="text-align: center; margin-top: 10px; font-size: 0.7rem;">¡Gracias por tu compra!</p>
                </div>
            `;
        };

        const printSaleReceipt = async (saleRecord) => {
            showMessageModal('Generando imagen del recibo...');
            const receiptHtml = generateThermalReceiptHtml(saleRecord);

            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.width = '250px';
            tempDiv.innerHTML = receiptHtml;
            document.body.appendChild(tempDiv);

            try {
                const canvas = await html2canvas(tempDiv, {
                    scale: 2,
                    logging: false,
                    useCORS: true
                });
                console.log('[printSaleReceipt] html2canvas ha generado el canvas.');

                const imageDataUrl = canvas.toDataURL('image/png');
                console.log('[printSaleReceipt] Data URL de la imagen generada. Longitud:', imageDataUrl.length);

                if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([], 'recibo.png', { type: 'image/png' })] })) {
                    const response = await fetch(imageDataUrl);
                    const blob = await response.blob();
                    const file = new File([blob], `recibo_venta_${saleRecord.client.nombreComercial.replace(/\s/g, '_')}_${saleRecord.date}.png`, { type: 'image/png' });

                    await navigator.share({
                        files: [file],
                        title: `Recibo de Venta ${saleRecord.fileName}`,
                        text: `Aquí tienes el recibo de venta para ${saleRecord.client.nombreComercial} del ${saleRecord.date}. Total: $${saleRecord.total.toFixed(2)}`,
                    });
                    showMessageModal('Recibo compartido exitosamente a través de las opciones de tu dispositivo.');
                    console.log('[printSaleReceipt] Recibo compartido a través de Web Share API.');
                } else {
                    showMessageModal('La función de compartir avanzada no está disponible en este navegador. Se descargará la imagen del recibo.');
                    console.warn('[printSaleReceipt] Web Share API no disponible o no puede compartir archivos. Se procede a la descarga.');

                    const link = document.createElement('a');
                    link.download = `recibo_venta_${saleRecord.client.nombreComercial.replace(/\s/g, '_')}_${saleRecord.date}.png`;
                    link.href = imageDataUrl;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showMessageModal('La imagen del recibo ha sido descargada.');
                }

            } catch (error) {
                console.error('[printSaleReceipt] Error al generar o compartir la imagen:', error);
                showMessageModal('Error al generar o compartir la imagen del recibo. Intenta de nuevo.');
            } finally {
                if (tempDiv && tempDiv.parentNode) {
                    document.body.removeChild(tempDiv);
                    console.log('[printSaleReceipt] Elemento temporal eliminado.');
                }
            }
        };


        // NUEVA: Pantalla de Archivos Admin
        const renderArchivosAdminScreen = () => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado: Solo los administradores pueden acceder a esta sección.');
                setScreenAndRender('main');
                return;
            }

            const archivosDiv = document.createElement('div');
            archivosDiv.className = 'screen-container bg-white rounded-xl m-2 shadow-md';
            archivosDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-5 text-center text-indigo-700">ARCHIVOS ADMIN</h2>
                <p class="text-base text-center my-5 text-gray-600">
                    Esta sección permite cargar y descargar archivos de datos maestros.
                </p>

                <div class="mb-8 p-4 bg-sky-50 rounded-lg border border-sky-300">
                    <h3 class="text-xl font-bold mb-4 text-sky-700">Cargar Archivos CSV</h3>
                    <div class="mb-3">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Cargar clientes.csv:</label>
                        <div class="file-input-wrapper">
                            <button class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-md w-full">Seleccionar archivo</button>
                            <input type="file" id="uploadClientsCsv" accept=".csv" onchange="handleFileUpload(event, 'clients')">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Cargar inventario.csv (Almacén Principal):</label>
                        <div class="file-input-wrapper">
                            <button class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-md w-full">Seleccionar archivo</button>
                            <input type="file" id="uploadInventoryCsv" accept=".csv" onchange="handleFileUpload(event, 'inventory')">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Cargar vendedor.csv:</label>
                        <div class="file-input-wrapper">
                            <button class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-md w-full">Seleccionar archivo</button>
                            <input type="file" id="uploadVendorsCsv" accept=".csv" onchange="handleFileUpload(event, 'vendors')">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Cargar vehículos.csv:</label>
                        <div class="file-input-wrapper">
                            <button class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-md w-full">Seleccionar archivo</button>
                            <input type="file" id="uploadVehiclesCsv" accept=".csv" onchange="handleFileUpload(event, 'vehicles')">
                        </div>
                    </div>
                </div>

                <div class="mb-8 p-4 bg-emerald-50 rounded-lg border border-emerald-300">
                    <h3 class="text-xl font-bold mb-4 text-emerald-700">Descargar Archivos de Datos</h3>
                    <button class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md w-full mb-2" onclick="downloadCurrentData('clients')">Descargar clientes.csv</button>
                    <button class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md w-full mb-2" onclick="downloadCurrentData('inventory')">Descargar inventario.csv (Almacén Principal)</button>
                    <button class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md w-full mb-2" onclick="downloadCurrentData('vendors')">Descargar vendedor.csv</button>
                    <button class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md w-full mb-2" onclick="downloadCurrentData('vehicles')">Descargar vehículos.csv</button>
                </div>

                <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg mt-5 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('main')">Volver</button>
            `;
            appRoot.appendChild(archivosDiv);
        };

        // NUEVA: Pantalla de Archivos de Venta (para todos los usuarios autenticados)
        const renderArchivosVentaScreen = () => {
            if (!currentUser) {
                showMessageModal('Acceso denegado: Debes iniciar sesión para ver los archivos de venta.');
                setScreenAndRender('login');
                return;
            }

            const archivosDiv = document.createElement('div');
            archivosDiv.className = 'screen-container bg-white rounded-xl m-2 shadow-md';
            archivosDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-5 text-center text-indigo-700">ARCHIVOS DE VENTA</h2>
                <p class="text-base text-center my-5 text-gray-600">
                    Aquí puedes ver, imprimir y modificar (solo administradores) los archivos de venta generados.
                </p>

                <div class="p-4 bg-cyan-50 rounded-lg border border-cyan-300">
                    <h3 class="text-xl font-bold mb-4 text-cyan-700">Archivos de Venta Generados</h3>
                    <div id="generated-sale-files-list"></div>
                </div>

                <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg mt-5 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('main')">Volver</button>
            `;
            appRoot.appendChild(archivosDiv);

            const generatedSaleFilesListDiv = document.getElementById('generated-sale-files-list');
            if (dailySales.length === 0) {
                generatedSaleFilesListDiv.innerHTML = '<p class="text-gray-600">No hay archivos de venta generados.</p>';
            } else {
                dailySales.forEach(sale => {
                    const fileItemDiv = document.createElement('div');
                    fileItemDiv.className = 'bg-cyan-100 p-3 rounded-lg mb-2 flex flex-wrap justify-between items-center border border-cyan-200';
                    fileItemDiv.innerHTML = `
                        <span class="text-base text-cyan-800 mb-2 sm:mb-0">${sale.fileName}</span>
                        <div class="flex flex-wrap gap-2">
                            <button class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-md text-sm transition duration-150 ease-in-out" onclick="printSaleReceipt(${JSON.stringify(sale).replace(/"/g, '&quot;')})">IMPRIMIR</button>
                            ${isAdmin() ? `<button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md text-sm transition duration-150 ease-in-out" onclick="openModifySaleModal(${JSON.stringify(sale).replace(/"/g, '&quot;')})">MODIFICAR</button>` : ''}
                        </div>
                    `;
                    generatedSaleFilesListDiv.appendChild(fileItemDiv);
                });
            }
        };


        const openModifySaleModal = (saleRecord) => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado: Solo los administradores pueden modificar ventas.');
                return;
            }
            selectedSaleForModification = JSON.parse(JSON.stringify(saleRecord));
            modifiedSaleQuantities = {};
            selectedSaleForModification.items.forEach(item => {
                modifiedSaleQuantities[item.sku] = item.cantidadVendida;
            });
            modificationReason = selectedSaleForModification.modificationReason || '';
            showModifySaleModalState = true;
            render();
        };

        const closeModifySaleModal = () => {
            showModifySaleModalState = false;
            selectedSaleForModification = null;
            modifiedSaleQuantities = {};
            modificationReason = '';
            render();
        };

        const handleModifiedSaleQuantityChange = (sku, quantity) => {
            modifiedSaleQuantities[sku] = parseInt(quantity) || 0;
        };

        const handleModificationReasonChange = (reason) => {
            modificationReason = reason;
        };

        const renderModifySaleModal = () => {
            if (!showModifySaleModalState || !selectedSaleForModification) return;

            const modalDiv = document.createElement('div');
            modalDiv.id = 'modify-sale-modal';
            modalDiv.className = 'modal';
            let productsHtml = '';
            let currentSaleSkus = new Set(selectedSaleForModification.items.map(item => item.sku));

            // Determinar el inventario a comparar según el origen de la venta
            const inventoryToCompare = selectedSaleForModification.sourceInventory === 'warehouse' ? inventory : currentTruckInventory;

            selectedSaleForModification.items.forEach(item => {
                const productInInventory = inventoryToCompare.find(invItem => invItem.sku === item.sku);
                const currentQuantity = modifiedSaleQuantities[item.sku] !== undefined ? modifiedSaleQuantities[item.sku] : item.cantidadVendida;
                productsHtml += `
                    <tr>
                        <td><img src="${productImages[item.sku] || productImages['default']}" alt="Imagen de ${item.producto}" class="w-10 h-10 rounded-md object-cover"></td>
                        <td>${item.sku}</td>
                        <td>${item.producto}</td>
                        <td>${item.presentacion}</td>
                        <td>$${item.precioUnitario.toFixed(2)}</td>
                        <td><input type="number" class="border border-gray-300 rounded-md text-center w-20" value="${currentQuantity}" onchange="handleModifiedSaleQuantityChange('${item.sku}', this.value)" min="0"></td>
                        <td>${productInInventory ? (productInInventory.quantity || productInInventory.cantidad) : 'N/A'}</td>
                    </tr>
                `;
            });

            inventoryToCompare.forEach(item => {
                if (!currentSaleSkus.has(item.sku)) {
                    const productInInventory = inventoryToCompare.find(invItem => invItem.sku === item.sku); // Re-fetch to ensure it's the correct item
                    const currentQuantity = modifiedSaleQuantities[item.sku] !== undefined ? modifiedSaleQuantities[item.sku] : 0;
                    productsHtml += `
                        <tr>
                            <td><img src="${productImages[item.sku] || productImages['default']}" alt="Imagen de ${item.producto}" class="w-10 h-10 rounded-md object-cover"></td>
                            <td>${item.sku}</td>
                            <td>${item.producto}</td>
                            <td>${item.presentacion}</td>
                            <td>$${item.price ? item.price.toFixed(2) : item.precio.toFixed(2)}</td>
                            <td><input type="number" class="border border-gray-300 rounded-md text-center w-20" value="${currentQuantity}" onchange="handleModifiedSaleQuantityChange('${item.sku}', this.value)" min="0"></td>
                            <td>${productInInventory ? (productInInventory.quantity || productInInventory.cantidad) : 'N/A'}</td>
                        </tr>
                    `;
                }
            });


            modalDiv.innerHTML = `
                <div class="modal-content">
                    <h3 class="text-2xl font-bold mb-4 text-center text-indigo-700">Modificar Venta</h3>
                    <p class="text-lg font-bold mb-2">Cliente: ${selectedSaleForModification.client.nombreComercial}</p>
                    <p class="text-md text-gray-700 mb-4">Fecha: ${selectedSaleForModification.date}</p>
                    <p class="text-md text-gray-700 mb-4">Origen: ${selectedSaleForModification.sourceInventory === 'warehouse' ? 'Almacén Principal' : `Camión ${selectedSaleForModification.sourceInventory}`}</p>

                    <div class="table-container mb-5">
                        <table>
                            <thead>
                                <tr>
                                    <th>Imagen</th>
                                    <th>SKU</th>
                                    <th>Producto</th>
                                    <th>Presentación</th>
                                    <th>Precio Unitario</th>
                                    <th>Cantidad</th>
                                    <th>Disp. Actual</th>
                                </tr>
                            </thead>
                            <tbody id="modify-sale-products-body">
                                ${productsHtml}
                            </tbody>
                        </table>
                    </div>

                    <div class="mb-4 text-left">
                        <label for="modificationReason" class="block text-gray-700 text-sm font-bold mb-2">Motivo de la Modificación:</label>
                        <textarea id="modificationReason" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" rows="3" onchange="handleModificationReasonChange(this.value)">${modificationReason}</textarea>
                    </div>

                    <div class="flex justify-around gap-4 mt-5">
                        <button class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-5 rounded-lg flex-1 shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="saveModifiedSale()">Guardar Modificación</button>
                        <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg flex-1 shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="closeModifySaleModal()">Cancelar</button>
                    </div>
                </div>
            `;
            appRoot.appendChild(modalDiv);
        };

        const saveModifiedSale = async () => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado: Solo los administradores pueden guardar modificaciones de ventas.');
                return;
            }
            if (!modificationReason.trim()) {
                showMessageModal('Por favor, ingresa un motivo para la modificación.');
                return;
            }

            const newSaleItems = [];
            let newTotalSaleAmount = 0;

            for (const sku in modifiedSaleQuantities) {
                const quantity = modifiedSaleQuantities[sku];
                if (quantity > 0) {
                    // Buscar el producto en el inventario principal o del camión según el origen de la venta
                    const product = (selectedSaleForModification.sourceInventory === 'warehouse' ? inventory : currentTruckInventory)
                                    .find(item => item.sku === sku);
                    if (product) {
                        const price = product.price !== undefined ? product.price : product.precio;
                        const subtotal = quantity * price;
                        newSaleItems.push({
                            sku: product.sku,
                            producto: product.producto,
                            presentacion: product.presentacion,
                            cantidadVendida: quantity,
                            precioUnitario: price,
                            subtotal: subtotal,
                        });
                        newTotalSaleAmount += subtotal;
                    }
                }
            }

            if (newSaleItems.length === 0) {
                showMessageModal('La venta modificada no puede estar vacía. Ajusta las cantidades.');
                return;
            }

            selectedSaleForModification.items = newSaleItems;
            selectedSaleForModification.total = newTotalSaleAmount;
            selectedSaleForModification.modificationReason = modificationReason.trim();

            selectedSaleForModification.rawCSV =
                `SKU,Producto,Presentacion,Cantidad,Precio Unitario,Subtotal\n` +
                newSaleItems.map(item => `${item.sku},${item.producto},${item.presentacion},${item.cantidadVendida},${item.precioUnitario.toFixed(2)},${item.subtotal.toFixed(2)}`).join('\n') +
                `\nTotal General:, , , , ,${newTotalSaleAmount.toFixed(2)}\n` +
                `Motivo de Modificación:,${modificationReason.trim()}`;


            const index = dailySales.findIndex(sale => sale.fileName === selectedSaleForModification.fileName);
            if (index !== -1) {
                try {
                    await db.collection('dailySales').doc(selectedSaleForModification.docId).set(selectedSaleForModification);
                    dailySales[index] = selectedSaleForModification;
                    showMessageModal('Venta modificada y guardada exitosamente en Firestore.');
                    closeModifySaleModal();
                    render();
                } catch (error) {
                    console.error('Error al modificar venta en Firestore:', error);
                    showMessageModal('Error al modificar venta. Por favor, revisa tu conexión y las reglas de seguridad.');
                }
            } else {
                showMessageModal('Error: No se encontró la venta original para modificar.');
                console.error('Error: No se encontró la venta original para modificar.');
            }
        };


        const handleFileUpload = async (event, type) => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado: Solo los administradores pueden cargar archivos CSV.');
                return;
            }
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const csvContent = e.target.result;
                const parsedData = parseCSV(csvContent);

                try {
                    if (type === 'clients') {
                        const existingClientsSnapshot = await db.collection('clients').get();
                        for (const doc of existingClientsSnapshot.docs) {
                            await db.collection('clients').doc(doc.id).delete();
                        }

                        const newClients = parsedData.map(row => ({
                            id: row.ID,
                            nombreComercial: row['Nombre Comercial'],
                            nombrePersonal: row['Nombre Personal'],
                            zona: row.Zona,
                            sector: row.Sector,
                            tlf: row.Tlf,
                            observaciones: row.Observaciones
                        }));
                        for (const client of newClients) {
                            await db.collection('clients').doc(client.id).set(client);
                        }
                        clients = newClients;
                        showMessageModal('clientes.csv cargado y guardado exitosamente en Firestore.');
                    } else if (type === 'inventory') {
                        const existingInventorySnapshot = await db.collection('inventory').get();
                        for (const doc of existingInventorySnapshot.docs) {
                            await db.collection('inventory').doc(doc.id).delete();
                        }

                        const newInventory = parsedData.map(row => ({
                            rubro: row.Rubro,
                            sku: row.Sku,
                            segmento: row.Segmento,
                            producto: row.Producto,
                            presentacion: row.Presentacion,
                            cantidad: parseInt(row.Cantidad) || 0,
                            precio: parseFloat(row.Precio) || 0
                        }));
                        for (const item of newInventory) {
                            await db.collection('inventory').doc(item.sku).set(item);
                        }
                        inventory = newInventory;
                        showMessageModal('inventario.csv cargado y guardado exitosamente en Firestore.');
                    } else if (type === 'vendors') {
                        const existingVendorsSnapshot = await db.collection('vendors').get();
                        for (const doc of existingVendorsSnapshot.docs) {
                            await db.collection('vendors').doc(doc.id).delete();
                        }

                        const newVendors = parsedData.map(row => ({
                            name: row['Wilfredo Chacon'] || row.Name,
                            category: row['Alimentos'] || row.Category
                        }));
                        for (const vendor of newVendors) {
                            await db.collection('vendors').doc(vendor.name.replace(/\s/g, '_')).set(vendor);
                        }
                        vendors = newVendors;
                        showMessageModal('vendedor.csv cargado y guardado exitosamente en Firestore.');
                        if (vendors.length > 0 && selectedVendor === 'Ninguno') {
                            selectedVendor = vendors[0].name;
                            localStorage.setItem('selectedVendor', selectedVendor);
                        }
                    } else if (type === 'vehicles') { // Cargar vehículos
                        const existingVehiclesSnapshot = await db.collection('vehicles').get();
                        for (const doc of existingVehiclesSnapshot.docs) {
                            await db.collection('vehicles').doc(doc.id).delete();
                            // También eliminar su inventario de camión asociado
                            await db.collection('truck_inventories').doc(doc.id).delete();
                        }

                        const newVehicles = parsedData.map(row => ({
                            plate: row.Plate,
                            name: row.Name,
                            brand: row.Brand,
                            model: row.Model
                        }));
                        for (const vehicle of newVehicles) {
                            await db.collection('vehicles').doc(vehicle.plate).set(vehicle);
                            // Crear inventario vacío para el nuevo camión
                            await db.collection('truck_inventories').doc(vehicle.plate).set({ items: [] });
                        }
                        vehicles = newVehicles;
                        showMessageModal('vehiculos.csv cargado y guardado exitosamente en Firestore.');
                    }
                    render();
                } catch (error) {
                    console.error('Error al cargar archivo CSV a Firestore:', error);
                    showMessageModal('Error al cargar archivo. Por favor, revisa tu conexión y las reglas de seguridad de Firestore.');
                }
            };
            reader.readAsText(file);
        };

        const downloadCurrentData = (dataType) => {
            let dataToDownload = [];
            let filename = '';
            let headers = [];

            if (dataType === 'clients') {
                dataToDownload = clients.map(c => ({
                    ID: c.id,
                    'Nombre Comercial': c.nombreComercial,
                    'Nombre Personal': c.nombrePersonal,
                    Zona: c.zona,
                    Sector: c.sector,
                    Tlf: c.tlf,
                    Observaciones: c.observaciones
                }));
                filename = 'clientes.csv';
                headers = ['ID', 'Nombre Comercial', 'Nombre Personal', 'Zona', 'Sector', 'Tlf', 'Observaciones'];
            } else if (dataType === 'inventory') {
                dataToDownload = inventory.map(i => ({
                    Rubro: i.rubro,
                    Sku: i.sku,
                    Segmento: i.segmento,
                    Producto: i.producto,
                    Presentacion: i.presentacion,
                    Cantidad: i.cantidad,
                    Precio: i.precio
                }));
                filename = 'inventario.csv';
                headers = ['Rubro', 'Sku', 'Segmento', 'Producto', 'Presentacion', 'Cantidad', 'Precio'];
            } else if (dataType === 'vendors') {
                dataToDownload = vendors.map(v => ({
                    Name: v.name,
                    Category: v.category
                }));
                filename = 'vendedor.csv';
                headers = ['Name', 'Category'];
            } else if (dataType === 'vehicles') { // Descargar vehículos
                dataToDownload = vehicles.map(v => ({
                    Plate: v.plate,
                    Name: v.name,
                    Brand: v.brand,
                    Model: v.model
                }));
                filename = 'vehiculos.csv';
                headers = ['Plate', 'Name', 'Brand', 'Model'];
            }

            if (dataToDownload.length > 0) {
                const csvContent = toCSV(dataToDownload, headers);
                downloadCSV(filename, csvContent);
            } else {
                showMessageModal(`No hay datos para descargar en ${dataType}.`);
            }
        };

        // --- PANTALLA: VEHÍCULOS DE CARGA ---
        const renderVehiclesScreen = () => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado: Solo los administradores pueden gestionar vehículos.');
                setScreenAndRender('main');
                return;
            }

            const vehiclesDiv = document.createElement('div');
            vehiclesDiv.className = 'screen-container bg-white rounded-xl m-2 shadow-md';
            vehiclesDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-5 text-center text-indigo-700">VEHÍCULOS DE CARGA</h2>

                <div class="mb-8 p-4 bg-emerald-50 rounded-lg border border-emerald-300">
                    <h3 class="text-xl font-bold mb-4 text-emerald-700">Lista de Vehículos</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Placa</th>
                                    <th>Nombre</th>
                                    <th>Marca</th>
                                    <th>Modelo</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="vehicles-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="p-4 bg-lime-50 rounded-lg border border-lime-300">
                    <h3 class="text-xl font-bold mb-4 text-lime-700">${editingVehicle ? 'Editar Vehículo' : 'Agregar Nuevo Vehículo'}</h3>
                    <input type="text" id="vehiclePlate" class="h-12 border border-gray-300 rounded-lg px-4 mb-3 text-base w-full bg-white" placeholder="Placa" ${editingVehicle ? 'disabled' : ''} value="${editingVehicle ? editingVehicle.plate : ''}">
                    <input type="text" id="vehicleName" class="h-12 border border-gray-300 rounded-lg px-4 mb-3 text-base w-full bg-white" placeholder="Nombre (ej. Volswaguen Worker 220)" value="${editingVehicle ? editingVehicle.name : ''}">
                    <input type="text" id="vehicleBrand" class="h-12 border border-gray-300 rounded-lg px-4 mb-3 text-base w-full bg-white" placeholder="Marca" value="${editingVehicle ? editingVehicle.brand : ''}">
                    <input type="text" id="vehicleModel" class="h-12 border border-gray-300 rounded-lg px-4 mb-3 text-base w-full bg-white" placeholder="Modelo" value="${editingVehicle ? editingVehicle.model : ''}">
                    <button class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-5 rounded-lg mt-3 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="${editingVehicle ? 'saveEditedVehicle()' : 'handleAddVehicle()'}">${editingVehicle ? 'Guardar Cambios' : 'Agregar Vehículo'}</button>
                    ${editingVehicle ? `<button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg mt-3 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="cancelEditVehicle()">Cancelar Edición</button>` : ''}
                </div>

                <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg mt-5 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('main')">Volver</button>
            `;
            appRoot.appendChild(vehiclesDiv);

            const vehiclesTableBody = document.getElementById('vehicles-table-body');
            vehicles.forEach(vehicle => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${vehicle.plate}</td>
                    <td>${vehicle.name}</td>
                    <td>${vehicle.brand || 'N/A'}</td>
                    <td>${vehicle.model || 'N/A'}</td>
                    <td>
                        <button class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-2 rounded-md text-sm mr-2" onclick="editVehicle('${vehicle.plate}')">Editar</button>
                        <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded-md text-sm" onclick="showDeleteVehicleConfirmation('${vehicle.plate}')">Eliminar</button>
                    </td>
                `;
                vehiclesTableBody.appendChild(row);
            });
        };

        const handleAddVehicle = async () => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado: Solo los administradores pueden agregar vehículos.');
                return;
            }
            const plate = document.getElementById('vehiclePlate').value.trim();
            const name = document.getElementById('vehicleName').value.trim();
            const brand = document.getElementById('vehicleBrand').value.trim();
            const model = document.getElementById('vehicleModel').value.trim();

            if (!plate || !name) {
                showMessageModal('La placa y el nombre del vehículo son obligatorios.');
                return;
            }
            if (vehicles.some(v => v.plate === plate)) {
                showMessageModal('Ya existe un vehículo con esta placa.');
                return;
            }

            const newVehicle = { plate, name, brand, model };
            try {
                await db.collection('vehicles').doc(plate).set(newVehicle);
                // Crear un inventario vacío para el nuevo camión
                await db.collection('truck_inventories').doc(plate).set({ items: [] });
                vehicles.push(newVehicle);
                showMessageModal('Vehículo agregado exitosamente y su inventario de camión creado.');
                render(); // Re-render para actualizar la lista y limpiar el formulario
            } catch (error) {
                console.error('Error al agregar vehículo:', error);
                showMessageModal('Error al agregar vehículo. Revisa tu conexión y reglas de seguridad.');
            }
        };

        const editVehicle = (plate) => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado: Solo los administradores pueden editar vehículos.');
                return;
            }
            editingVehicle = vehicles.find(v => v.plate === plate);
            render();
        };

        const cancelEditVehicle = () => {
            editingVehicle = null;
            render();
        };

        const saveEditedVehicle = async () => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado: Solo los administradores pueden guardar cambios en vehículos.');
                return;
            }
            if (!editingVehicle) return;

            const name = document.getElementById('vehicleName').value.trim();
            const brand = document.getElementById('vehicleBrand').value.trim();
            const model = document.getElementById('vehicleModel').value.trim();

            if (!name) {
                showMessageModal('El nombre del vehículo es obligatorio.');
                return;
            }

            const updatedVehicle = { ...editingVehicle, name, brand, model };
            try {
                await db.collection('vehicles').doc(updatedVehicle.plate).set(updatedVehicle);
                vehicles = vehicles.map(v => v.plate === updatedVehicle.plate ? updatedVehicle : v);
                showMessageModal('Vehículo actualizado exitosamente.');
                editingVehicle = null;
                render();
            } catch (error) {
                console.error('Error al actualizar vehículo:', error);
                showMessageModal('Error al actualizar vehículo. Revisa tu conexión y reglas de seguridad.');
            }
        };

        const showDeleteVehicleConfirmation = (plate) => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado: Solo los administradores pueden eliminar vehículos.');
                return;
            }
            showConfirmationModal(`¿Estás seguro de que quieres eliminar el vehículo con placa ${plate}? Esto también eliminará su inventario de camión.`, () => deleteVehicle(plate));
        };

        const deleteVehicle = async (plate) => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado: Solo los administradores pueden eliminar vehículos.');
                return;
            }
            try {
                await db.collection('vehicles').doc(plate).delete();
                await db.collection('truck_inventories').doc(plate).delete(); // Eliminar también el inventario del camión
                vehicles = vehicles.filter(v => v.plate !== plate);
                showMessageModal('Vehículo y su inventario de camión eliminados exitosamente.');
                render();
            } catch (error) {
                console.error('Error al eliminar vehículo:', error);
                showMessageModal('Error al eliminar vehículo. Revisa tu conexión y reglas de seguridad.');
            }
        };

        // --- PANTALLA: ASIGNACIÓN DE VEHÍCULO A VENDEDOR ---
        const renderAssignVehicleScreen = () => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado: Solo los administradores pueden asignar vehículos.');
                setScreenAndRender('main');
                return;
            }

            const assignVehicleDiv = document.createElement('div');
            assignVehicleDiv.className = 'screen-container bg-white rounded-xl m-2 shadow-md';
            assignVehicleDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-5 text-center text-indigo-700">ASIGNAR VEHÍCULO A VENDEDOR</h2>

                <div class="mb-8 p-4 bg-blue-50 rounded-lg border border-blue-300">
                    <h3 class="text-xl font-bold mb-4 text-blue-700">Asignar Camión a Usuarios</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Correo Electrónico</th>
                                    <th>Rol</th>
                                    <th>Camión Asignado</th>
                                    <th>Asignar Nuevo Camión</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="user-assignment-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>

                <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg mt-5 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('main')">Volver</button>
            `;
            appRoot.appendChild(assignVehicleDiv);

            const userAssignmentTableBody = document.getElementById('user-assignment-table-body');
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td>${user.assignedTruckPlate || 'Ninguno'}</td>
                    <td>
                        <select id="assignTruck-${user.uid}" class="h-10 border border-gray-300 rounded-lg px-2 text-sm w-full bg-white">
                            <option value="">-- No asignar --</option>
                            ${vehicles.map(v => `<option value="${v.plate}" ${user.assignedTruckPlate === v.plate ? 'selected' : ''}>${v.name} (${v.plate})</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <button class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-3 rounded-md text-sm" onclick="handleAssignVehicle('${user.uid}')">Guardar</button>
                    </td>
                `;
                userAssignmentTableBody.appendChild(row);
            });
        };

        const handleAssignVehicle = async (userId) => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado: Solo los administradores pueden asignar vehículos.');
                return;
            }
            const selectElement = document.getElementById(`assignTruck-${userId}`);
            const newAssignedTruckPlate = selectElement.value || null; // Si es vacío, asignar null

            try {
                await db.collection('users').doc(userId).update({
                    assignedTruckPlate: newAssignedTruckPlate
                });
                // Actualizar el estado local de los usuarios
                users = users.map(u => u.uid === userId ? { ...u, assignedTruckPlate: newAssignedTruckPlate } : u);

                // Si el usuario asignado es el usuario actual, actualizar también currentUserData
                if (currentUser && currentUser.uid === userId) {
                    currentUserData.assignedTruckPlate = newAssignedTruckPlate;
                }

                showMessageModal(`Vehículo asignado exitosamente al usuario ${users.find(u => u.uid === userId).email}.`);
                render(); // Re-render para actualizar la tabla
            } catch (error) {
                console.error('Error al asignar vehículo:', error);
                showMessageModal('Error al asignar vehículo. Revisa tu conexión y reglas de seguridad.');
            }
        };

        // --- PANTALLA: CARGA DE INVENTARIO (RECEPCIÓN) ---
        let selectedTruckInventoryForReceiving = []; // Inventario del camión seleccionado para cargar
        let selectedTruckForReceiving = null; // Placa del camión seleccionado para cargar
        let selectedLoader = null; // Nombre del cargador seleccionado
        let receivingQuantities = {}; // Cantidades a cargar por SKU

        const renderCargaSelectionScreen = () => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado: Solo los administradores pueden acceder a esta sección.');
                setScreenAndRender('main');
                return;
            }

            const cargaSelectionDiv = document.createElement('div');
            cargaSelectionDiv.className = 'screen-container bg-white rounded-xl m-2 shadow-md';
            cargaSelectionDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-5 text-center text-indigo-700">SELECCIÓN DE CARGA</h2>

                <div class="mb-8 p-4 bg-yellow-50 rounded-lg border border-yellow-300">
                    <h3 class="text-xl font-bold mb-4 text-yellow-700">Opciones de Carga</h3>
                    <button class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-5 rounded-lg mt-3 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('truckLoading')">CARGA DE CAMIÓN (RECEPCIÓN)</button>
                    <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg mt-3 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('loadHistory')">HISTORIAL DE CARGAS</button>
                    <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-5 rounded-lg mt-3 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('resetCargasInicialesPassword')">RESET CARGAS INICIALES</button>
                </div>

                <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg mt-5 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('main')">Volver</button>
            `;
            appRoot.appendChild(cargaSelectionDiv);
        };

        const renderTruckReceivingScreen = () => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado: Solo los administradores pueden realizar cargas.');
                setScreenAndRender('main');
                return;
            }

            const receivingDiv = document.createElement('div');
            receivingDiv.className = 'screen-container bg-white rounded-xl m-2 shadow-md';
            receivingDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-5 text-center text-indigo-700">CARGA DE CAMIÓN (RECEPCIÓN)</h2>

                <div class="mb-5">
                    <label for="truckSelect" class="block text-gray-700 text-sm font-bold mb-2">Seleccionar Camión:</label>
                    <select id="truckSelect" class="shadow border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" onchange="handleTruckSelectionForReceiving(this.value)">
                        <option value="">-- Selecciona un camión --</option>
                        ${vehicles.map(v => `<option value="${v.plate}" ${selectedTruckForReceiving === v.plate ? 'selected' : ''}>${v.name} (${v.plate})</option>`).join('')}
                    </select>
                </div>

                <div class="mb-5">
                    <label for="loaderSelect" class="block text-gray-700 text-sm font-bold mb-2">Seleccionar Cargador:</label>
                    <select id="loaderSelect" class="shadow border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" onchange="selectedLoader = this.value; render()">
                        <option value="">-- Selecciona un cargador --</option>
                        ${vendors.map(v => `<option value="${v.name}" ${selectedLoader === v.name ? 'selected' : ''}>${v.name}</option>`).join('')}
                    </select>
                </div>

                ${selectedTruckForReceiving && selectedLoader ? `
                <div class="mb-8 p-4 bg-blue-50 rounded-lg border border-blue-300">
                    <h3 class="text-xl font-bold mb-4 text-blue-700">Inventario a Cargar en ${selectedTruckForReceiving}</h3>
                    <div class="table-container mb-5">
                        <table>
                            <thead>
                                <tr>
                                    <th>Imagen</th>
                                    <th>SKU</th>
                                    <th>Producto</th>
                                    <th>Presentación</th>
                                    <th>Cantidad Almacén</th>
                                    <th>Cantidad a Cargar</th>
                                    <th>Cantidad en Camión</th>
                                </tr>
                            </thead>
                            <tbody id="receiving-products-body">
                                ${inventory.map(item => {
                                    const currentTruckQty = (selectedTruckInventoryForReceiving.find(ti => ti.sku === item.sku)?.quantity || 0);
                                    const quantityToReceive = receivingQuantities[item.sku] !== undefined ? receivingQuantities[item.sku] : 0;
                                    return `
                                        <tr>
                                            <td><img src="${productImages[item.sku] || productImages['default']}" alt="Imagen de ${item.producto}" class="w-10 h-10 rounded-md object-cover"></td>
                                            <td>${item.sku}</td>
                                            <td>${item.producto}</td>
                                            <td>${item.presentacion}</td>
                                            <td>${item.cantidad}</td>
                                            <td><input type="number" class="border border-gray-300 rounded-md text-center w-20" value="${quantityToReceive}" onchange="handleReceivingQuantityChange('${item.sku}', this.value)" min="0" max="${item.cantidad}"></td>
                                            <td>${currentTruckQty}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="showConfirmReceiving()">Confirmar Carga</button>
                </div>
                ` : '<p class="text-center text-gray-600">Selecciona un camión y un cargador para continuar.</p>'}

                <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg mt-5 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('cargaSelection')">Volver</button>
            `;
            appRoot.appendChild(receivingDiv);
        };

        const handleTruckSelectionForReceiving = async (plate) => {
            selectedTruckForReceiving = plate;
            if (plate) {
                try {
                    const truckInventoryDoc = await db.collection('truck_inventories').doc(plate).get();
                    if (truckInventoryDoc.exists) {
                        selectedTruckInventoryForReceiving = truckInventoryDoc.data().items || [];
                    } else {
                        selectedTruckInventoryForReceiving = [];
                        console.warn(`No se encontró inventario para el camión ${plate}. Se creará uno vacío.`);
                        await db.collection('truck_inventories').doc(plate).set({ items: [] });
                    }
                } catch (error) {
                    console.error('Error al cargar inventario del camión:', error);
                    showMessageModal('Error al cargar el inventario del camión. Intenta de nuevo.');
                    selectedTruckInventoryForReceiving = [];
                }
            } else {
                selectedTruckInventoryForReceiving = [];
            }
            receivingQuantities = {}; // Reset quantities when truck changes
            render();
        };

        const handleReceivingQuantityChange = (sku, quantity) => {
            const parsedQuantity = parseInt(quantity);
            if (!isNaN(parsedQuantity) && parsedQuantity >= 0) {
                receivingQuantities[sku] = parsedQuantity;
            } else {
                receivingQuantities[sku] = 0;
            }
        };

        const showConfirmReceiving = () => {
            const itemsToReceive = Object.keys(receivingQuantities).filter(sku => receivingQuantities[sku] > 0);
            if (itemsToReceive.length === 0) {
                showMessageModal('No hay productos seleccionados para cargar.');
                return;
            }

            let confirmationMessage = `¿Estás seguro de cargar los siguientes productos en el camión ${selectedTruckForReceiving} por ${selectedLoader}?\n\n`;
            itemsToReceive.forEach(sku => {
                const item = inventory.find(i => i.sku === sku);
                if (item) {
                    confirmationMessage += `${item.producto} (${item.presentacion}): ${receivingQuantities[sku]} unidades.\n`;
                }
            });

            showConfirmationModal(confirmationMessage, performReceiving);
        };

        const performReceiving = async () => {
            const batch = db.batch();
            const date = getCurrentDateFormatted();
            const loadRecordId = db.collection('loadRecords').doc().id; // Generar un ID para el registro de carga

            const itemsLoaded = [];
            let totalItemsLoaded = 0;

            for (const sku in receivingQuantities) {
                const quantityToLoad = receivingQuantities[sku];
                if (quantityToLoad > 0) {
                    const mainInventoryItem = inventory.find(item => item.sku === sku);
                    if (mainInventoryItem && mainInventoryItem.cantidad >= quantityToLoad) {
                        // Deduct from main inventory
                        const newMainQuantity = mainInventoryItem.cantidad - quantityToLoad;
                        const mainInventoryRef = db.collection('inventory').doc(sku);
                        batch.update(mainInventoryRef, { cantidad: newMainQuantity });
                        mainInventoryItem.cantidad = newMainQuantity; // Update local state

                        // Add to truck inventory
                        const truckInventoryRef = db.collection('truck_inventories').doc(selectedTruckForReceiving);
                        const existingTruckItem = selectedTruckInventoryForReceiving.find(item => ti.sku === sku);

                        let newTruckItems;
                        if (existingTruckItem) {
                            newTruckItems = selectedTruckInventoryForReceiving.map(item =>
                                item.sku === sku ? { ...item, quantity: item.quantity + quantityToLoad } : item
                            );
                        } else {
                            const productDetails = inventory.find(item => item.sku === sku);
                            newTruckItems = [...selectedTruckInventoryForReceiving, {
                                sku: productDetails.sku,
                                producto: productDetails.producto,
                                presentacion: productDetails.presentacion,
                                price: productDetails.precio, // Usar 'price' para consistencia con inventario de camión
                                quantity: quantityToLoad
                            }];
                        }
                        batch.set(truckInventoryRef, { items: newTruckItems });
                        selectedTruckInventoryForReceiving = newTruckItems; // Update local state

                        itemsLoaded.push({
                            sku: mainInventoryItem.sku,
                            producto: mainInventoryItem.producto,
                            presentacion: mainInventoryItem.presentacion,
                            cantidadCargada: quantityToLoad,
                            precio: mainInventoryItem.precio // Registrar el precio al momento de la carga
                        });
                        totalItemsLoaded += quantityToLoad;

                    } else {
                        showMessageModal(`Error: Cantidad insuficiente de ${mainInventoryItem?.producto || sku} en el almacén.`);
                        return; // Detener la operación si no hay suficiente stock
                    }
                }
            }

            if (itemsLoaded.length === 0) {
                showMessageModal('No se cargaron productos válidos.');
                return;
            }

            // Create load record
            const loadRecord = {
                loadId: loadRecordId,
                date: date,
                truckPlate: selectedTruckForReceiving,
                loader: selectedLoader,
                items: itemsLoaded,
                totalItemsLoaded: totalItemsLoaded,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            const loadRecordRef = db.collection('loadRecords').doc(loadRecordId);
            batch.set(loadRecordRef, loadRecord);
            loadRecords.push(loadRecord); // Update local state

            try {
                await batch.commit();
                showMessageModal('Carga de inventario confirmada y guardada exitosamente.');
                receivingQuantities = {}; // Clear quantities after successful load
                await fetchDataFromFirestore(); // Re-fetch all data to ensure consistency
                setScreenAndRender('loadHistory'); // Ir al historial de cargas
            } catch (error) {
                console.error('Error al confirmar la carga:', error);
                showMessageModal('Error al confirmar la carga. Por favor, revisa tu conexión y las reglas de seguridad.');
            }
        };

        const renderLoadHistoryScreen = () => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado: Solo los administradores pueden ver el historial de cargas.');
                setScreenAndRender('main');
                return;
            }

            const loadHistoryDiv = document.createElement('div');
            loadHistoryDiv.className = 'screen-container bg-white rounded-xl m-2 shadow-md';
            loadHistoryDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-5 text-center text-indigo-700">HISTORIAL DE CARGAS</h2>

                <div class="mb-8 p-4 bg-purple-50 rounded-lg border border-purple-300">
                    <h3 class="text-xl font-bold mb-4 text-purple-700">Registros de Carga</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Camión</th>
                                    <th>Cargador</th>
                                    <th>Total Items</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="load-history-table-body">
                            </tbody>
                        </table>
                    </div>
                    <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg mt-4 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="showClearLoadHistoryConfirmation()">Borrar Historial de Cargas</button>
                </div>

                <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg mt-5 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('cargaSelection')">Volver</button>
            `;
            appRoot.appendChild(loadHistoryDiv);

            const loadHistoryTableBody = document.getElementById('load-history-table-body');
            if (loadRecords.length === 0) {
                loadHistoryTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">No hay registros de carga.</td></tr>';
            } else {
                loadRecords.sort((a, b) => (b.timestamp?.toDate() || new Date(0)) - (a.timestamp?.toDate() || new Date(0))).forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.date}</td>
                        <td>${record.truckPlate}</td>
                        <td>${record.loader}</td>
                        <td>${record.totalItemsLoaded}</td>
                        <td>
                            <button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded-md text-sm mr-2" onclick="viewLoadDetails('${record.loadId}')">Ver Detalles</button>
                            <button class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded-md text-sm" onclick="downloadLoadRecordCSV('${record.loadId}')">Descargar CSV</button>
                        </td>
                    `;
                    loadHistoryTableBody.appendChild(row);
                });
            }
        };

        const viewLoadDetails = (loadId) => {
            const record = loadRecords.find(r => r.loadId === loadId);
            if (record) {
                let detailsMessage = `Detalles de Carga - Camión: ${record.truckPlate}, Cargador: ${record.loader}, Fecha: ${record.date}\n\n`;
                record.items.forEach(item => {
                    detailsMessage += `- ${item.producto} (${item.presentacion}): ${item.cantidadCargada} unidades\n`;
                });
                showMessageModal(detailsMessage);
            } else {
                showMessageModal('Registro de carga no encontrado.');
            }
        };

        const downloadLoadRecordCSV = (loadId) => {
            const record = loadRecords.find(r => r.loadId === loadId);
            if (record) {
                let csvContent = `Registro de Carga\n`;
                csvContent += `ID de Carga:,${record.loadId}\n`;
                csvContent += `Fecha:,${record.date}\n`;
                csvContent += `Camión:,${record.truckPlate}\n`;
                csvContent += `Cargador:,${record.loader}\n`;
                csvContent += `Total Items Cargados:,${record.totalItemsLoaded}\n\n`;
                csvContent += `SKU,Producto,Presentacion,Cantidad Cargada,Precio Unitario\n`;
                record.items.forEach(item => {
                    csvContent += `${item.sku},${item.producto},${item.presentacion},${item.cantidadCargada},${item.precio}\n`;
                });
                downloadCSV(`carga_${record.truckPlate}_${record.date}.csv`, csvContent);
            } else {
                showMessageModal('Registro de carga no encontrado para descargar.');
            }
        };

        const showClearLoadHistoryConfirmation = () => {
            showConfirmationModal('¿Estás seguro de que quieres borrar TODO el historial de cargas? Esta acción es irreversible.', clearLoadHistoryLogic);
        };

        const clearLoadHistoryLogic = async () => {
            const batch = db.batch();
            loadRecords.forEach(record => {
                const docRef = db.collection('loadRecords').doc(record.docId);
                batch.delete(docRef);
            });

            try {
                await batch.commit();
                loadRecords = []; // Limpiar el estado local
                showMessageModal('Historial de cargas borrado exitosamente.');
                render();
            } catch (error) {
                console.error('Error al borrar historial de cargas:', error);
                showMessageModal('Error al borrar historial de cargas. Revisa tu conexión y reglas de seguridad.');
            }
        };

        // --- PANTALLA: RESET CARGAS INICIALES ---
        let resetQuantities = {};
        let allTruckInventories = {}; // Para almacenar todos los inventarios de camiones para edición

        const renderResetCargasInicialesPasswordScreen = () => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado: Solo los administradores pueden acceder a esta función.');
                setScreenAndRender('main');
                return;
            }

            const passwordScreenDiv = document.createElement('div');
            passwordScreenDiv.className = 'screen-container bg-white rounded-xl shadow-md p-8 max-w-md mx-auto my-10';
            passwordScreenDiv.innerHTML = `
                <h2 class="text-3xl font-bold mb-6 text-center text-indigo-700">RESET CARGAS INICIALES</h2>
                <p class="text-center text-gray-700 mb-4">Esta es una función sensible. Por favor, ingresa tu contraseña de administrador para continuar.</p>
                <input type="password" id="adminPasswordReset" class="h-12 border border-gray-300 rounded-lg px-4 mb-6 text-base w-full bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Contraseña de Administrador">
                <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-5 rounded-lg w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="handleResetCargasInicialesPassword()">Confirmar</button>
                <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg mt-4 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('cargaSelection')">Volver</button>
            `;
            appRoot.appendChild(passwordScreenDiv);
        };

        const handleResetCargasInicialesPassword = async () => {
            const password = document.getElementById('adminPasswordReset').value;
            if (!password) {
                showMessageModal('Por favor, ingresa la contraseña.');
                return;
            }

            try {
                // Re-autenticar al usuario para verificar la contraseña
                const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, password);
                await currentUser.reauthenticateWithCredential(credential);

                // Si la re-autenticación es exitosa, cargar todos los inventarios de camiones
                await fetchAllTruckInventoriesForReset();
                setScreenAndRender('resetCargasInicialesEdit');
            } catch (error) {
                console.error('Error de autenticación para reset:', error);
                showMessageModal('Contraseña incorrecta o error de autenticación. Intenta de nuevo.');
            }
        };

        const fetchAllTruckInventoriesForReset = async () => {
            try {
                const truckInventoriesSnapshot = await db.collection('truck_inventories').get();
                allTruckInventories = {};
                truckInventoriesSnapshot.docs.forEach(doc => {
                    allTruckInventories[doc.id] = doc.data().items || [];
                });
                console.log('[ResetCargasIniciales] Todos los inventarios de camiones cargados:', allTruckInventories);
            } catch (error) {
                console.error('Error al cargar todos los inventarios de camiones para reset:', error);
                showMessageModal('Error al cargar inventarios de camiones para reset. Revisa tu conexión.');
            }
        };

        const renderResetCargasInicialesEditScreen = () => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado.');
                setScreenAndRender('main');
                return;
            }

            const editScreenDiv = document.createElement('div');
            editScreenDiv.className = 'screen-container bg-white rounded-xl m-2 shadow-md';
            let contentHtml = `<h2 class="text-2xl font-bold mb-5 text-center text-indigo-700">EDITAR CARGAS INICIALES DE CAMIONES</h2>`;

            if (Object.keys(allTruckInventories).length === 0) {
                contentHtml += `<p class="text-center text-gray-600">No hay camiones con inventario para editar.</p>`;
            } else {
                for (const plate in allTruckInventories) {
                    const truckName = vehicles.find(v => v.plate === plate)?.name || `Camión ${plate}`;
                    contentHtml += `
                        <div class="mb-8 p-4 bg-teal-50 rounded-lg border border-teal-300">
                            <h3 class="text-xl font-bold mb-4 text-teal-700">Inventario de ${truckName} (${plate})</h3>
                            <div class="table-container mb-5">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Imagen</th>
                                            <th>SKU</th>
                                            <th>Producto</th>
                                            <th>Presentación</th>
                                            <th>Cantidad Actual</th>
                                            <th>Nueva Cantidad</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${inventory.map(item => {
                                            const currentTruckQty = (allTruckInventories[plate].find(ti => ti.sku === item.sku)?.quantity || 0);
                                            const resetQtyKey = `${plate}-${item.sku}`;
                                            const quantityToSet = resetQuantities[resetQtyKey] !== undefined ? resetQuantities[resetQtyKey] : currentTruckQty;
                                            return `
                                                <tr>
                                                    <td><img src="${productImages[item.sku] || productImages['default']}" alt="Imagen de ${item.producto}" class="w-10 h-10 rounded-md object-cover"></td>
                                                    <td>${item.sku}</td>
                                                    <td>${item.producto}</td>
                                                    <td>${item.presentacion}</td>
                                                    <td>${currentTruckQty}</td>
                                                    <td><input type="number" class="border border-gray-300 rounded-md text-center w-20" value="${quantityToSet}" onchange="handleResetQuantityChange('${plate}', '${item.sku}', this.value)" min="0"></td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                contentHtml += `<button class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 mt-5" onclick="showConfirmResetCargasIniciales()">Guardar Cambios de Cargas Iniciales</button>`;
            }

            contentHtml += `<button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg mt-5 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('cargaSelection')">Volver</button>`;
            editScreenDiv.innerHTML = contentHtml;
            appRoot.appendChild(editScreenDiv);
        };

        const handleResetQuantityChange = (plate, sku, quantity) => {
            const parsedQuantity = parseInt(quantity);
            const resetQtyKey = `${plate}-${sku}`;
            if (!isNaN(parsedQuantity) && parsedQuantity >= 0) {
                resetQuantities[resetQtyKey] = parsedQuantity;
            } else {
                resetQuantities[resetQtyKey] = 0;
            }
        };

        const showConfirmResetCargasIniciales = () => {
            showConfirmationModal('¿Estás seguro de guardar los nuevos inventarios iniciales de los camiones? Esto sobrescribirá las cantidades actuales.', performResetCargasIniciales);
        };

        const performResetCargasIniciales = async () => {
            const batch = db.batch();
            let changesMade = false;

            for (const plate in allTruckInventories) {
                let newTruckInventoryItems = [];
                const currentTruckInventoryForPlate = allTruckInventories[plate];

                // Crear un mapa para un acceso más fácil a las cantidades actuales por SKU
                const currentTruckInventoryMap = new Map(currentTruckInventoryForPlate.map(item => [item.sku, item]));

                for (const item of inventory) { // Iterar sobre el inventario principal para asegurar que todos los SKUs estén considerados
                    const resetQtyKey = `${plate}-${item.sku}`;
                    const newQuantity = resetQuantities[resetQtyKey] !== undefined ? resetQuantities[resetQtyKey] : (currentTruckInventoryMap.get(item.sku)?.quantity || 0);

                    if (newQuantity > 0) {
                        newTruckInventoryItems.push({
                            sku: item.sku,
                            producto: item.producto,
                            presentacion: item.presentacion,
                            price: item.precio,
                            quantity: newQuantity
                        });
                    }

                    // Detectar si hubo un cambio para este SKU en este camión
                    const oldQuantity = currentTruckInventoryMap.get(item.sku)?.quantity || 0;
                    if (newQuantity !== oldQuantity) {
                        changesMade = true;
                    }
                }

                const truckInventoryRef = db.collection('truck_inventories').doc(plate);
                batch.set(truckInventoryRef, { items: newTruckInventoryItems });
            }

            if (!changesMade) {
                showMessageModal('No se detectaron cambios en las cargas iniciales.');
                resetQuantities = {};
                setScreenAndRender('cargaSelection');
                return;
            }

            try {
                await batch.commit();
                showMessageModal('Cargas iniciales de camiones actualizadas exitosamente.');
                resetQuantities = {}; // Limpiar estado después de guardar
                await fetchDataFromFirestore(); // Re-fetch all data to ensure consistency
                setScreenAndRender('cargaSelection');
            } catch (error) {
                console.error('Error al guardar las cargas iniciales:', error);
                showMessageModal('Error al guardar las cargas iniciales. Revisa tu conexión y reglas de seguridad.');
            }
        };

        // --- PANTALLA: INVENTARIO (USUARIO Y ADMIN) ---
        const renderInventarioScreen = () => {
            const inventarioDiv = document.createElement('div');
            inventarioDiv.className = 'screen-container bg-white rounded-xl m-2 shadow-md';
            inventarioDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-5 text-center text-indigo-700">INVENTARIO ${isUser() && currentUserData.assignedTruckPlate ? `DE MI CAMIÓN (${currentUserData.assignedTruckPlate})` : 'PRINCIPAL'}</h2>
                <p class="text-base text-center my-5 text-gray-600">
                    ${isUser() && currentUserData.assignedTruckPlate ? 'Aquí puedes ver el inventario disponible en tu camión.' : 'Aquí puedes ver el inventario disponible en el almacén principal.'}
                </p>
                <div class="table-container mb-5">
                    <table>
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>SKU</th>
                                <th>Producto</th>
                                <th>Presentación</th>
                                <th>Cantidad</th>
                                <th>Precio</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body">
                        </tbody>
                    </table>
                </div>
                <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg mt-5 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('main')">Volver</button>
            `;
            appRoot.appendChild(inventarioDiv);

            const inventoryTableBody = document.getElementById('inventory-table-body');
            const displayInventory = (isUser() && currentUserData.assignedTruckPlate) ? currentTruckInventory : inventory;

            if (displayInventory.length === 0) {
                inventoryTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">No hay productos en este inventario.</td></tr>';
            } else {
                displayInventory.forEach(item => {
                    const row = document.createElement('tr');
                    // Ajustar para que 'cantidad' sea 'quantity' si viene de truck_inventories
                    const quantity = item.quantity !== undefined ? item.quantity : item.cantidad;
                    const price = item.price !== undefined ? item.price : item.precio;

                    row.innerHTML = `
                        <td><img src="${productImages[item.sku] || productImages['default']}" alt="Imagen de ${item.producto}" class="w-10 h-10 rounded-md object-cover"></td>
                        <td>${item.sku}</td>
                        <td>${item.producto}</td>
                        <td>${item.presentacion}</td>
                        <td>${quantity}</td>
                        <td>$${price ? price.toFixed(2) : 'N/A'}</td>
                    `;
                    inventoryTableBody.appendChild(row);
                });
            }
        };

        // --- PANTALLA: SELECCIÓN DE INVENTARIO ADMIN ---
        const renderAdminInventorySelection = () => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado: Solo los administradores pueden acceder a esta sección.');
                setScreenAndRender('main');
                return;
            }

            const adminInventoryDiv = document.createElement('div');
            adminInventoryDiv.className = 'screen-container bg-white rounded-xl m-2 shadow-md';
            adminInventoryDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-5 text-center text-indigo-700">SELECCIÓN DE INVENTARIO (ADMIN)</h2>

                <div class="mb-8 p-4 bg-yellow-50 rounded-lg border border-yellow-300">
                    <h3 class="text-xl font-bold mb-4 text-yellow-700">Opciones de Inventario</h3>
                    <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg mt-3 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('inventario')">VER INVENTARIO PRINCIPAL</button>
                    <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg mt-3 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('adminVehicleInventory')">VER INVENTARIO DE CAMIONES</button>
                </div>

                <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg mt-5 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('main')">Volver</button>
            `;
            appRoot.appendChild(adminInventoryDiv);
        };

        // --- PANTALLA: INVENTARIO DE VEHÍCULOS (ADMIN) ---
        const renderAdminVehicleInventoryScreen = () => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado: Solo los administradores pueden ver el inventario de camiones.');
                setScreenAndRender('main');
                return;
            }

            const vehicleInventoryDiv = document.createElement('div');
            vehicleInventoryDiv.className = 'screen-container bg-white rounded-xl m-2 shadow-md';
            vehicleInventoryDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-5 text-center text-indigo-700">INVENTARIO DE CAMIONES (ADMIN)</h2>

                <div class="mb-5">
                    <label for="adminVehicleSelect" class="block text-gray-700 text-sm font-bold mb-2">Seleccionar Camión:</label>
                    <select id="adminVehicleSelect" class="shadow border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" onchange="handleAdminVehicleSelection(this.value)">
                        <option value="">-- Selecciona un camión --</option>
                        ${vehicles.map(v => `<option value="${v.plate}" ${selectedAdminVehicleForInventory === v.plate ? 'selected' : ''}>${v.name} (${v.plate})</option>`).join('')}
                    </select>
                </div>

                ${selectedAdminVehicleForInventory ? `
                <div class="mb-8 p-4 bg-blue-50 rounded-lg border border-blue-300">
                    <h3 class="text-xl font-bold mb-4 text-blue-700">Inventario de ${vehicles.find(v => v.plate === selectedAdminVehicleForInventory)?.name || selectedAdminVehicleForInventory}</h3>
                    <div class="table-container mb-5">
                        <table>
                            <thead>
                                <tr>
                                    <th>Imagen</th>
                                    <th>SKU</th>
                                    <th>Producto</th>
                                    <th>Presentación</th>
                                    <th>Cantidad</th>
                                    <th>Precio</th>
                                </tr>
                            </thead>
                            <tbody id="admin-truck-inventory-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : '<p class="text-center text-gray-600">Selecciona un camión para ver su inventario.</p>'}

                <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg mt-5 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('adminInventorySelection')">Volver</button>
            `;
            appRoot.appendChild(vehicleInventoryDiv);

            if (selectedAdminVehicleForInventory) {
                const adminTruckInventoryTableBody = document.getElementById('admin-truck-inventory-table-body');
                const truckInventory = allTruckInventories[selectedAdminVehicleForInventory] || [];

                if (truckInventory.length === 0) {
                    adminTruckInventoryTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">No hay productos en el inventario de este camión.</td></tr>';
                } else {
                    truckInventory.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><img src="${productImages[item.sku] || productImages['default']}" alt="Imagen de ${item.producto}" class="w-10 h-10 rounded-md object-cover"></td>
                            <td>${item.sku}</td>
                            <td>${item.producto}</td>
                            <td>${item.presentacion}</td>
                            <td>${item.quantity}</td>
                            <td>$${item.price ? item.price.toFixed(2) : 'N/A'}</td>
                        `;
                        adminTruckInventoryTableBody.appendChild(row);
                    });
                }
            }
        };

        const handleAdminVehicleSelection = async (plate) => {
            selectedAdminVehicleForInventory = plate;
            if (plate && !allTruckInventories[plate]) {
                // Si no tenemos el inventario de este camión, cárgalo
                try {
                    const truckInventoryDoc = await db.collection('truck_inventories').doc(plate).get();
                    if (truckInventoryDoc.exists) {
                        allTruckInventories[plate] = truckInventoryDoc.data().items || [];
                    } else {
                        allTruckInventories[plate] = [];
                        console.warn(`No se encontró inventario para el camión ${plate}. Se creará uno vacío.`);
                        await db.collection('truck_inventories').doc(plate).set({ items: [] });
                    }
                } catch (error) {
                    console.error('Error al cargar inventario del camión para admin:', error);
                    showMessageModal('Error al cargar el inventario del camión. Intenta de nuevo.');
                    allTruckInventories[plate] = [];
                }
            }
            render();
        };

        // --- PANTALLA: CLIENTES ---
        const renderClientesScreen = () => {
            const clientesDiv = document.createElement('div');
            clientesDiv.className = 'screen-container bg-white rounded-xl m-2 shadow-md';
            clientesDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-5 text-center text-indigo-700">GESTIÓN DE CLIENTES</h2>

                <div class="mb-5">
                    <input type="text" id="clientSearchInputClientes" class="h-12 border border-gray-300 rounded-lg px-4 mb-4 text-base w-full bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Buscar cliente por nombre o ID..." value="${clientSearchTermClientes}" oninput="clientSearchTermClientes = this.value; render()">
                </div>

                <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg w-full mb-5 shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="showAddClientForm = true; render()">Agregar Nuevo Cliente</button>

                ${showAddClientForm ? `
                <div class="mb-8 p-4 bg-emerald-50 rounded-lg border border-emerald-300">
                    <h3 class="text-xl font-bold mb-4 text-emerald-700">Agregar Cliente</h3>
                    <input type="text" id="newClientId" class="h-10 border border-gray-300 rounded-lg px-3 mb-3 text-base w-full bg-white" placeholder="ID del Cliente" value="${newClient.id}" oninput="newClient.id = this.value">
                    <input type="text" id="newClientNombreComercial" class="h-10 border border-gray-300 rounded-lg px-3 mb-3 text-base w-full bg-white" placeholder="Nombre Comercial" value="${newClient.nombreComercial}" oninput="newClient.nombreComercial = this.value">
                    <input type="text" id="newClientNombrePersonal" class="h-10 border border-gray-300 rounded-lg px-3 mb-3 text-base w-full bg-white" placeholder="Nombre Personal" value="${newClient.nombrePersonal}" oninput="newClient.nombrePersonal = this.value">
                    <input type="text" id="newClientZona" class="h-10 border border-gray-300 rounded-lg px-3 mb-3 text-base w-full bg-white" placeholder="Zona" value="${newClient.zona}" oninput="newClient.zona = this.value">
                    <input type="text" id="newClientSector" class="h-10 border border-gray-300 rounded-lg px-3 mb-3 text-base w-full bg-white" placeholder="Sector" value="${newClient.sector}" oninput="newClient.sector = this.value">
                    <input type="text" id="newClientTlf" class="h-10 border border-gray-300 rounded-lg px-3 mb-3 text-base w-full bg-white" placeholder="Teléfono" value="${newClient.tlf}" oninput="newClient.tlf = this.value">
                    <textarea id="newClientObservaciones" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-3" rows="3" placeholder="Observaciones" oninput="newClient.observaciones = this.value">${newClient.observaciones}</textarea>
                    <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="handleAddClient()">Guardar Cliente</button>
                    <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg w-full mt-2 shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="showAddClientForm = false; newClient = { id: '', nombreComercial: '', nombrePersonal: '', zona: '', sector: '', tlf: '', observaciones: '' }; render()">Cancelar</button>
                </div>
                ` : ''}

                <div class="table-container mb-5">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre Comercial</th>
                                <th>Zona</th>
                                <th>Teléfono</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clients-table-body">
                        </tbody>
                    </table>
                </div>

                <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg mt-5 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('main')">Volver</button>
            `;
            appRoot.appendChild(clientesDiv);

            const clientsTableBody = document.getElementById('clients-table-body');
            const filteredClients = clients.filter(client =>
                client.nombreComercial.toLowerCase().includes(clientSearchTermClientes.toLowerCase()) ||
                client.id.toLowerCase().includes(clientSearchTermClientes.toLowerCase())
            );

            if (filteredClients.length === 0) {
                clientsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">No hay clientes que coincidan con la búsqueda.</td></tr>';
            } else {
                filteredClients.forEach(client => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${client.id}</td>
                        <td>${client.nombreComercial}</td>
                        <td>${client.zona}</td>
                        <td>${client.tlf}</td>
                        <td>
                            <button class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-2 rounded-md text-sm mr-2" onclick="openEditClientModal('${client.id}')">Editar</button>
                            <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded-md text-sm" onclick="showDeleteClientConfirmation('${client.id}')">Eliminar</button>
                        </td>
                    `;
                    clientsTableBody.appendChild(row);
                });
            }

            if (showEditClientModal) {
                renderEditClientModal();
            }
        };

        const handleAddClient = async () => {
            if (!newClient.id || !newClient.nombreComercial) {
                showMessageModal('El ID y el Nombre Comercial del cliente son obligatorios.');
                return;
            }
            if (clients.some(c => c.id === newClient.id)) {
                showMessageModal('Ya existe un cliente con este ID.');
                return;
            }

            try {
                await db.collection('clients').doc(newClient.id).set(newClient);
                clients.push(newClient);
                showMessageModal('Cliente agregado exitosamente.');
                showAddClientForm = false;
                newClient = { id: '', nombreComercial: '', nombrePersonal: '', zona: '', sector: '', tlf: '', observaciones: '' }; // Limpiar formulario
                render();
            } catch (error) {
                console.error('Error al agregar cliente:', error);
                showMessageModal('Error al agregar cliente. Revisa tu conexión y reglas de seguridad.');
            }
        };

        let editingClient = null;
        let showEditClientModal = false;

        const openEditClientModal = (clientId) => {
            editingClient = clients.find(c => c.id === clientId);
            if (editingClient) {
                // Crear una copia para evitar modificar el estado directamente antes de guardar
                editingClient = { ...editingClient };
                showEditClientModal = true;
                render();
            } else {
                showMessageModal('Cliente no encontrado para editar.');
            }
        };

        const closeEditClientModal = () => {
            editingClient = null;
            showEditClientModal = false;
            render();
        };

        const handleEditClientChange = (field, value) => {
            if (editingClient) {
                editingClient[field] = value;
            }
        };

        const renderEditClientModal = () => {
            if (!showEditClientModal || !editingClient) return;

            const modalDiv = document.createElement('div');
            modalDiv.id = 'edit-client-modal';
            modalDiv.className = 'modal';
            modalDiv.innerHTML = `
                <div class="modal-content">
                    <h3 class="text-2xl font-bold mb-4 text-center text-indigo-700">Editar Cliente</h3>
                    <div class="mb-3">
                        <label class="block text-gray-700 text-sm font-bold mb-2">ID del Cliente:</label>
                        <input type="text" class="h-10 border border-gray-300 rounded-lg px-3 text-base w-full bg-gray-100" value="${editingClient.id}" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Nombre Comercial:</label>
                        <input type="text" class="h-10 border border-gray-300 rounded-lg px-3 text-base w-full bg-white" value="${editingClient.nombreComercial}" oninput="handleEditClientChange('nombreComercial', this.value)">
                    </div>
                    <div class="mb-3">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Nombre Personal:</label>
                        <input type="text" class="h-10 border border-gray-300 rounded-lg px-3 text-base w-full bg-white" value="${editingClient.nombrePersonal}" oninput="handleEditClientChange('nombrePersonal', this.value)">
                    </div>
                    <div class="mb-3">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Zona:</label>
                        <input type="text" class="h-10 border border-gray-300 rounded-lg px-3 text-base w-full bg-white" value="${editingClient.zona}" oninput="handleEditClientChange('zona', this.value)">
                    </div>
                    <div class="mb-3">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Sector:</label>
                        <input type="text" class="h-10 border border-gray-300 rounded-lg px-3 text-base w-full bg-white" value="${editingClient.sector}" oninput="handleEditClientChange('sector', this.value)">
                    </div>
                    <div class="mb-3">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Teléfono:</label>
                        <input type="text" class="h-10 border border-gray-300 rounded-lg px-3 text-base w-full bg-white" value="${editingClient.tlf}" oninput="handleEditClientChange('tlf', this.value)">
                    </div>
                    <div class="mb-3">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Observaciones:</label>
                        <textarea class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" rows="3" oninput="handleEditClientChange('observaciones', this.value)">${editingClient.observaciones}</textarea>
                    </div>
                    <div class="flex justify-around gap-4 mt-5">
                        <button class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-5 rounded-lg flex-1 shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="saveEditedClient()">Guardar Cambios</button>
                        <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg flex-1 shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="closeEditClientModal()">Cancelar</button>
                    </div>
                </div>
            `;
            appRoot.appendChild(modalDiv);
        };

        const saveEditedClient = async () => {
            if (!editingClient.nombreComercial) {
                showMessageModal('El Nombre Comercial es obligatorio.');
                return;
            }

            try {
                await db.collection('clients').doc(editingClient.id).set(editingClient);
                clients = clients.map(c => c.id === editingClient.id ? editingClient : c); // Actualizar el estado local
                showMessageModal('Cliente actualizado exitosamente.');
                closeEditClientModal();
                render();
            } catch (error) {
                console.error('Error al guardar cliente editado:', error);
                showMessageModal('Error al guardar cliente. Revisa tu conexión y reglas de seguridad.');
            }
        };

        const showDeleteClientConfirmation = (clientId) => {
            showConfirmationModal(`¿Estás seguro de que quieres eliminar el cliente con ID ${clientId}?`, () => deleteClient(clientId));
        };

        const deleteClient = async (clientId) => {
            try {
                await db.collection('clients').doc(clientId).delete();
                clients = clients.filter(c => c.id !== clientId); // Actualizar el estado local
                showMessageModal('Cliente eliminado exitosamente.');
                render();
            } catch (error) {
                console.error('Error al eliminar cliente:', error);
                showMessageModal('Error al eliminar cliente. Revisa tu conexión y reglas de seguridad.');
            }
        };

        // --- PANTALLA: VENTA ---
        const renderVentaScreen = () => {
            if (!isUser()) {
                showMessageModal('Acceso denegado: Solo los vendedores pueden realizar ventas.');
                setScreenAndRender('main');
                return;
            }
            if (!currentUserData.assignedTruckPlate) {
                showMessageModal('No tienes un camión asignado. Por favor, contacta a un administrador.');
                setScreenAndRender('main');
                return;
            }
            if (currentTruckInventory.length === 0) {
                showMessageModal('Tu camión no tiene inventario. Por favor, carga inventario primero.');
                setScreenAndRender('main');
                return;
            }

            const ventaDiv = document.createElement('div');
            ventaDiv.className = 'screen-container bg-white rounded-xl m-2 shadow-md';
            ventaDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-5 text-center text-indigo-700">REGISTRAR VENTA</h2>

                <div class="mb-5 p-4 bg-purple-50 rounded-lg border border-purple-300">
                    <h3 class="text-xl font-bold mb-4 text-purple-700">Cliente Seleccionado:</h3>
                    ${selectedClientForSale ?
                        `<p class="text-lg font-semibold">${selectedClientForSale.nombreComercial}</p>
                        <p class="text-gray-700">ID: ${selectedClientForSale.id}</p>
                        <p class="text-gray-700">Zona: ${selectedClientForSale.zona}, Sector: ${selectedClientForSale.sector}</p>
                        <p class="text-gray-700">Teléfono: ${selectedClientForSale.tlf}</p>
                        <button class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg mt-3 shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="showClientPicker()">Cambiar Cliente</button>`
                        :
                        `<p class="text-gray-600">Ningún cliente seleccionado.</p>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-3 shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="showClientPicker()">Seleccionar Cliente</button>`
                    }
                </div>

                <div class="mb-8 p-4 bg-teal-50 rounded-lg border border-teal-300">
                    <h3 class="text-xl font-bold mb-4 text-teal-700">Productos del Camión (${currentUserData.assignedTruckPlate})</h3>
                    <div class="table-container mb-5">
                        <table>
                            <thead>
                                <tr>
                                    <th>Imagen</th>
                                    <th>SKU</th>
                                    <th>Producto</th>
                                    <th>Presentación</th>
                                    <th>Precio Unitario</th>
                                    <th>Cant. Disponible</th>
                                    <th>Cant. a Vender</th>
                                </tr>
                            </thead>
                            <tbody id="sale-products-body">
                                ${currentTruckInventory.map(item => {
                                    const quantityToSell = saleQuantities[item.sku] !== undefined ? saleQuantities[item.sku] : 0;
                                    return `
                                        <tr>
                                            <td><img src="${productImages[item.sku] || productImages['default']}" alt="Imagen de ${item.producto}" class="w-10 h-10 rounded-md object-cover"></td>
                                            <td>${item.sku}</td>
                                            <td>${item.producto}</td>
                                            <td>${item.presentacion}</td>
                                            <td>$${item.price.toFixed(2)}</td>
                                            <td>${item.quantity}</td>
                                            <td><input type="number" class="border border-gray-300 rounded-md text-center w-20" value="${quantityToSell}" onchange="handleSaleQuantityChange('${item.sku}', this.value)" min="0" max="${item.quantity}"></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="showConfirmSale()">Confirmar Venta</button>
                </div>

                <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg mt-5 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('main')">Volver</button>
            `;
            appRoot.appendChild(ventaDiv);

            if (showClientPickerModal) {
                renderClientPickerModal();
            }
        };

        const showClientPicker = () => {
            clientSearchTerm = ''; // Limpiar el término de búsqueda al abrir
            showClientPickerModal = true;
            render();
        };

        const renderClientPickerModal = () => {
            if (!showClientPickerModal) return;

            const modalDiv = document.createElement('div');
            modalDiv.id = 'client-picker-modal';
            modalDiv.className = 'modal';
            modalDiv.innerHTML = `
                <div class="modal-content">
                    <h3 class="text-2xl font-bold mb-4 text-center text-indigo-700">Seleccionar Cliente</h3>
                    <input type="text" id="clientSearchInput" class="h-12 border border-gray-300 rounded-lg px-4 mb-4 text-base w-full bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Buscar cliente por nombre o ID..." value="${clientSearchTerm}" oninput="clientSearchTerm = this.value; renderClientPickerModalContent()">
                    <div class="table-container mb-5 max-h-60 overflow-y-auto">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre Comercial</th>
                                    <th>Zona</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody id="client-picker-table-body">
                            </tbody>
                        </table>
                    </div>
                    <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="showClientPickerModal = false; render()">Cerrar</button>
                </div>
            `;
            appRoot.appendChild(modalDiv);
            renderClientPickerModalContent(); // Cargar el contenido de la tabla inicialmente
        };

        const renderClientPickerModalContent = () => {
            const clientPickerTableBody = document.getElementById('client-picker-table-body');
            if (!clientPickerTableBody) return; // Asegúrate de que el modal esté renderizado

            clientPickerTableBody.innerHTML = ''; // Limpiar contenido anterior

            const filteredClients = clients.filter(client =>
                client.nombreComercial.toLowerCase().includes(clientSearchTerm.toLowerCase()) ||
                client.id.toLowerCase().includes(clientSearchTerm.toLowerCase())
            );

            if (filteredClients.length === 0) {
                clientPickerTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">No hay clientes que coincidan.</td></tr>';
            } else {
                filteredClients.forEach(client => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${client.id}</td>
                        <td>${client.nombreComercial}</td>
                        <td>${client.zona}</td>
                        <td><button class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-1 px-3 rounded-md text-sm" onclick="selectClientForSale('${client.id}')">Seleccionar</button></td>
                    `;
                    clientPickerTableBody.appendChild(row);
                });
            }
        };

        const selectClientForSale = (clientId) => {
            selectedClientForSale = clients.find(c => c.id === clientId);
            showClientPickerModal = false;
            render(); // Re-renderizar la pantalla de venta para mostrar el cliente seleccionado
        };

        const handleSaleQuantityChange = (sku, quantity) => {
            const parsedQuantity = parseInt(quantity);
            const productInTruck = currentTruckInventory.find(item => item.sku === sku);

            if (productInTruck) {
                if (!isNaN(parsedQuantity) && parsedQuantity >= 0 && parsedQuantity <= productInTruck.quantity) {
                    saleQuantities[sku] = parsedQuantity;
                } else if (parsedQuantity > productInTruck.quantity) {
                    saleQuantities[sku] = productInTruck.quantity;
                    showMessageModal(`No puedes vender más de la cantidad disponible (${productInTruck.quantity}) para ${productInTruck.producto}.`);
                } else {
                    saleQuantities[sku] = 0;
                }
            } else {
                saleQuantities[sku] = 0; // No se puede vender si no está en el camión
                showMessageModal(`Producto con SKU ${sku} no encontrado en el inventario de tu camión.`);
            }
            // No es necesario renderizar aquí, se renderizará en showConfirmSale o al final de la interacción
        };

        const showConfirmSale = () => {
            if (!selectedClientForSale) {
                showMessageModal('Por favor, selecciona un cliente primero.');
                return;
            }

            const itemsToSell = Object.keys(saleQuantities).filter(sku => saleQuantities[sku] > 0);
            if (itemsToSell.length === 0) {
                showMessageModal('No hay productos seleccionados para la venta.');
                return;
            }

            let confirmationMessage = `¿Estás seguro de registrar la siguiente venta para ${selectedClientForSale.nombreComercial}?\n\n`;
            let totalSaleAmount = 0;
            itemsToSell.forEach(sku => {
                const item = currentTruckInventory.find(i => i.sku === sku);
                if (item) {
                    const subtotal = saleQuantities[sku] * item.price;
                    confirmationMessage += `${item.producto} (${item.presentacion}): ${saleQuantities[sku]} x $${item.price.toFixed(2)} = $${subtotal.toFixed(2)}\n`;
                    totalSaleAmount += subtotal;
                }
            });
            confirmationMessage += `\nTotal de la Venta: $${totalSaleAmount.toFixed(2)}`;

            showConfirmationModal(confirmationMessage, performSale);
        };

        const performSale = async () => {
            const batch = db.batch();
            const date = getCurrentDateFormatted();
            const saleId = db.collection('dailySales').doc().id; // Generar un ID para la venta

            const itemsSold = [];
            let totalSaleAmount = 0;

            for (const sku in saleQuantities) {
                const quantitySold = saleQuantities[sku];
                if (quantitySold > 0) {
                    const productInTruck = currentTruckInventory.find(item => item.sku === sku);
                    if (productInTruck && productInTruck.quantity >= quantitySold) {
                        const newQuantityInTruck = productInTruck.quantity - quantitySold;
                        const truckInventoryRef = db.collection('truck_inventories').doc(currentUserData.assignedTruckPlate);

                        // Actualizar la cantidad en el inventario del camión
                        const updatedTruckItems = currentTruckInventory.map(item =>
                            item.sku === sku ? { ...item, quantity: newQuantityInTruck } : item
                        );
                        batch.set(truckInventoryRef, { items: updatedTruckItems });
                        productInTruck.quantity = newQuantityInTruck; // Actualizar estado local

                        const subtotal = quantitySold * productInTruck.price;
                        itemsSold.push({
                            sku: productInTruck.sku,
                            producto: productInTruck.producto,
                            presentacion: productInTruck.presentacion,
                            cantidadVendida: quantitySold,
                            precioUnitario: productInTruck.price,
                            subtotal: subtotal
                        });
                        totalSaleAmount += subtotal;
                    } else {
                        showMessageModal(`Error: Cantidad insuficiente de ${productInTruck?.producto || sku} en tu camión.`);
                        return; // Detener la operación si no hay suficiente stock
                    }
                }
            }

            if (itemsSold.length === 0) {
                showMessageModal('No se vendieron productos válidos.');
                return;
            }

            const fileName = `venta_${selectedClientForSale.id}_${date}_${saleId.substring(0, 5)}.csv`;
            const saleRecord = {
                saleId: saleId,
                date: date,
                client: selectedClientForSale,
                vendor: currentUser.email,
                items: itemsSold,
                total: totalSaleAmount,
                fileName: fileName,
                sourceInventory: currentUserData.assignedTruckPlate, // Registrar el camión de origen
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            const saleRef = db.collection('dailySales').doc(saleId);
            batch.set(saleRef, saleRecord);
            dailySales.push(saleRecord); // Actualizar estado local

            try {
                await batch.commit();
                showMessageModal('Venta registrada exitosamente.');
                selectedClientForSale = null; // Limpiar cliente seleccionado
                saleQuantities = {}; // Limpiar cantidades de venta
                await fetchDataFromFirestore(); // Re-fetch all data to ensure consistency (especially truck inventory)
                setScreenAndRender('venta'); // Mantener en la pantalla de venta o volver a main
            } catch (error) {
                console.error('Error al registrar la venta:', error);
                showMessageModal('Error al registrar la venta. Por favor, revisa tu conexión y las reglas de seguridad.');
            }
        };

        // --- PANTALLA: TRANSBORDO DE INVENTARIO ---
        const renderTransferInventoryPasswordScreen = () => {
            if (!isUser()) {
                showMessageModal('Acceso denegado: Solo los vendedores pueden realizar transbordos.');
                setScreenAndRender('main');
                return;
            }
            if (!currentUserData.assignedTruckPlate) {
                showMessageModal('No tienes un camión asignado para realizar transbordos.');
                setScreenAndRender('main');
                return;
            }

            const passwordScreenDiv = document.createElement('div');
            passwordScreenDiv.className = 'screen-container bg-white rounded-xl shadow-md p-8 max-w-md mx-auto my-10';
            passwordScreenDiv.innerHTML = `
                <h2 class="text-3xl font-bold mb-6 text-center text-indigo-700">TRANSBORDO DE INVENTARIO</h2>
                <p class="text-center text-gray-700 mb-4">Esta es una función sensible. Por favor, ingresa tu contraseña para continuar.</p>
                <input type="password" id="transferPassword" class="h-12 border border-gray-300 rounded-lg px-4 mb-6 text-base w-full bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Contraseña">
                <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-5 rounded-lg w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="handleTransferInventoryPassword()">Confirmar</button>
                <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg mt-4 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('main')">Volver</button>
            `;
            appRoot.appendChild(passwordScreenDiv);
        };

        const handleTransferInventoryPassword = async () => {
            const password = document.getElementById('transferPassword').value;
            if (!password) {
                showMessageModal('Por favor, ingresa la contraseña.');
                return;
            }

            try {
                // Re-autenticar al usuario para verificar la contraseña
                const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, password);
                await currentUser.reauthenticateWithCredential(credential);

                // Si la re-autenticación es exitosa, ir a la pantalla de transbordo
                setScreenAndRender('transferInventory');
            } catch (error) {
                console.error('Error de autenticación para transbordo:', error);
                showMessageModal('Contraseña incorrecta o error de autenticación. Intenta de nuevo.');
            }
        };

        const renderTransferInventoryScreen = () => {
            if (!isUser() || !currentUserData.assignedTruckPlate) {
                showMessageModal('Acceso denegado o no hay camión asignado.');
                setScreenAndRender('main');
                return;
            }

            const transferDiv = document.createElement('div');
            transferDiv.className = 'screen-container bg-white rounded-xl m-2 shadow-md';
            transferDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-5 text-center text-indigo-700">TRANSBORDO DE INVENTARIO</h2>
                <p class="text-base text-center my-5 text-gray-600">
                    Transfiere inventario desde tu camión (${currentUserData.assignedTruckPlate}) a otro camión.
                </p>

                <div class="mb-5">
                    <label for="destinationTruckSelect" class="block text-gray-700 text-sm font-bold mb-2">Seleccionar Camión de Destino:</label>
                    <select id="destinationTruckSelect" class="shadow border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" onchange="handleDestinationTruckSelection(this.value)">
                        <option value="">-- Selecciona un camión de destino --</option>
                        ${vehicles.filter(v => v.plate !== currentUserData.assignedTruckPlate).map(v => `<option value="${v.plate}" ${selectedDestinationTruck === v.plate ? 'selected' : ''}>${v.name} (${v.plate})</option>`).join('')}
                    </select>
                </div>

                ${selectedDestinationTruck ? `
                <div class="mb-8 p-4 bg-blue-50 rounded-lg border border-blue-300">
                    <h3 class="text-xl font-bold mb-4 text-blue-700">Inventario a Transferir desde tu Camión (${currentUserData.assignedTruckPlate})</h3>
                    <div class="table-container mb-5">
                        <table>
                            <thead>
                                <tr>
                                    <th>Imagen</th>
                                    <th>SKU</th>
                                    <th>Producto</th>
                                    <th>Presentación</th>
                                    <th>Cant. en tu Camión</th>
                                    <th>Cant. a Transferir</th>
                                </tr>
                            </thead>
                            <tbody id="transfer-products-body">
                                ${currentTruckInventory.map(item => {
                                    const quantityToTransfer = transferQuantities[item.sku] !== undefined ? transferQuantities[item.sku] : 0;
                                    return `
                                        <tr>
                                            <td><img src="${productImages[item.sku] || productImages['default']}" alt="Imagen de ${item.producto}" class="w-10 h-10 rounded-md object-cover"></td>
                                            <td>${item.sku}</td>
                                            <td>${item.producto}</td>
                                            <td>${item.presentacion}</td>
                                            <td>${item.quantity}</td>
                                            <td><input type="number" class="border border-gray-300 rounded-md text-center w-20" value="${quantityToTransfer}" onchange="handleTransferQuantityChange('${item.sku}', this.value)" min="0" max="${item.quantity}"></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="showTransferConfirmation()">Confirmar Transbordo</button>
                </div>
                ` : '<p class="text-center text-gray-600">Selecciona un camión de destino para ver el inventario a transferir.</p>'}

                <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg mt-5 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('main')">Volver</button>
            `;
            appRoot.appendChild(transferDiv);
        };

        const handleDestinationTruckSelection = (plate) => {
            selectedDestinationTruck = plate;
            transferQuantities = {}; // Reset quantities when destination truck changes
            render();
        };

        const handleTransferQuantityChange = (sku, quantity) => {
            const parsedQuantity = parseInt(quantity);
            const productInSourceTruck = currentTruckInventory.find(item => item.sku === sku);

            if (productInSourceTruck) {
                if (!isNaN(parsedQuantity) && parsedQuantity >= 0 && parsedQuantity <= productInSourceTruck.quantity) {
                    transferQuantities[sku] = parsedQuantity;
                } else if (parsedQuantity > productInSourceTruck.quantity) {
                    transferQuantities[sku] = productInSourceTruck.quantity;
                    showMessageModal(`No puedes transferir más de la cantidad disponible (${productInSourceTruck.quantity}) para ${productInSourceTruck.producto}.`);
                } else {
                    transferQuantities[sku] = 0;
                }
            } else {
                transferQuantities[sku] = 0; // No se puede transferir si no está en el camión de origen
                showMessageModal(`Producto con SKU ${sku} no encontrado en el inventario de tu camión.`);
            }
        };

        const showTransferConfirmation = () => {
            if (!selectedDestinationTruck) {
                showMessageModal('Por favor, selecciona un camión de destino.');
                return;
            }

            const itemsToTransfer = Object.keys(transferQuantities).filter(sku => transferQuantities[sku] > 0);
            if (itemsToTransfer.length === 0) {
                showMessageModal('No hay productos seleccionados para transferir.');
                return;
            }

            let confirmationMessage = `¿Estás seguro de transferir los siguientes productos desde tu camión (${currentUserData.assignedTruckPlate}) al camión ${selectedDestinationTruck}?\n\n`;
            itemsToTransfer.forEach(sku => {
                const item = currentTruckInventory.find(i => i.sku === sku);
                if (item) {
                    confirmationMessage += `${item.producto} (${item.presentacion}): ${transferQuantities[sku]} unidades.\n`;
                }
            });

            showConfirmationModal(confirmationMessage, performInventoryTransfer);
        };

        const performInventoryTransfer = async () => {
            const batch = db.batch();
            const date = getCurrentDateFormatted();
            const transferId = db.collection('transferRecords').doc().id;

            const itemsTransferred = [];
            let totalItemsTransferred = 0;

            const destinationTruckInventoryDoc = await db.collection('truck_inventories').doc(selectedDestinationTruck).get();
            let destinationTruckItems = destinationTruckInventoryDoc.exists ? (destinationTruckInventoryDoc.data().items || []) : [];

            for (const sku in transferQuantities) {
                const quantityToTransfer = transferQuantities[sku];
                if (quantityToTransfer > 0) {
                    const productInSourceTruck = currentTruckInventory.find(item => item.sku === sku);

                    if (productInSourceTruck && productInSourceTruck.quantity >= quantityToTransfer) {
                        // Deduct from source truck inventory
                        const newQuantityInSourceTruck = productInSourceTruck.quantity - quantityToTransfer;
                        const sourceTruckRef = db.collection('truck_inventories').doc(currentUserData.assignedTruckPlate);
                        const updatedSourceTruckItems = currentTruckInventory.map(item =>
                            item.sku === sku ? { ...item, quantity: newQuantityInSourceTruck } : item
                        );
                        batch.set(sourceTruckRef, { items: updatedSourceTruckItems });
                        productInSourceTruck.quantity = newQuantityInSourceTruck; // Update local state

                        // Add to destination truck inventory
                        const existingDestinationItem = destinationTruckItems.find(item => item.sku === sku);
                        if (existingDestinationItem) {
                            destinationTruckItems = destinationTruckItems.map(item =>
                                item.sku === sku ? { ...item, quantity: item.quantity + quantityToTransfer } : item
                            );
                        } else {
                            const productDetails = inventory.find(item => item.sku === sku); // Get full product details
                            destinationTruckItems.push({
                                sku: productDetails.sku,
                                producto: productDetails.producto,
                                presentacion: productDetails.presentacion,
                                price: productDetails.precio,
                                quantity: quantityToTransfer
                            });
                        }

                        itemsTransferred.push({
                            sku: productInSourceTruck.sku,
                            producto: productInSourceTruck.producto,
                            presentacion: productInSourceTruck.presentacion,
                            cantidadTransferida: quantityToTransfer,
                            price: productInSourceTruck.price
                        });
                        totalItemsTransferred += quantityToTransfer;

                    } else {
                        showMessageModal(`Error: Cantidad insuficiente de ${productInSourceTruck?.producto || sku} en tu camión para transferir.`);
                        return;
                    }
                }
            }

            if (itemsTransferred.length === 0) {
                showMessageModal('No se seleccionaron productos válidos para transferir.');
                return;
            }

            // Update destination truck inventory in Firestore
            const destinationTruckRef = db.collection('truck_inventories').doc(selectedDestinationTruck);
            batch.set(destinationTruckRef, { items: destinationTruckItems });

            // Create transfer record
            const transferRecord = {
                transferId: transferId,
                date: date,
                sourceTruckPlate: currentUserData.assignedTruckPlate,
                destinationTruckPlate: selectedDestinationTruck,
                userId: currentUser.uid,
                userEmail: currentUser.email,
                items: itemsTransferred,
                totalItemsTransferred: totalItemsTransferred,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            const transferRecordRef = db.collection('transferRecords').doc(transferId);
            batch.set(transferRecordRef, transferRecord);
            transferRecords.push(transferRecord); // Update local state

            try {
                await batch.commit();
                showMessageModal('Transbordo de inventario realizado exitosamente.');
                selectedDestinationTruck = null; // Clear selection
                transferQuantities = {}; // Clear quantities
                await fetchDataFromFirestore(); // Re-fetch all data to ensure consistency
                setScreenAndRender('main'); // Go back to main screen or transfer history
            } catch (error) {
                console.error('Error al realizar el transbordo:', error);
                showMessageModal('Error al realizar el transbordo. Por favor, revisa tu conexión y las reglas de seguridad.');
            }
        };

        const renderAdminTransferHistoryScreen = () => {
            if (!isAdmin()) {
                showMessageModal('Acceso denegado: Solo los administradores pueden ver el historial de transbordos.');
                setScreenAndRender('main');
                return;
            }

            const transferHistoryDiv = document.createElement('div');
            transferHistoryDiv.className = 'screen-container bg-white rounded-xl m-2 shadow-md';
            transferHistoryDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-5 text-center text-indigo-700">HISTORIAL DE TRANSBORDOS (ADMIN)</h2>

                <div class="mb-8 p-4 bg-purple-50 rounded-lg border border-purple-300">
                    <h3 class="text-xl font-bold mb-4 text-purple-700">Registros de Transbordo</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Origen</th>
                                    <th>Destino</th>
                                    <th>Usuario</th>
                                    <th>Total Items</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="transfer-history-table-body">
                            </tbody>
                        </table>
                    </div>
                    <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg mt-4 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="showClearTransferHistoryConfirmation()">Borrar Historial de Transbordos</button>
                </div>

                <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg mt-5 w-full shadow-md transition duration-300 ease-in-out transform hover:scale-105" onclick="setScreenAndRender('main')">Volver</button>
            `;
            appRoot.appendChild(transferHistoryDiv);

            const transferHistoryTableBody = document.getElementById('transfer-history-table-body');
            if (transferRecords.length === 0) {
                transferHistoryTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">No hay registros de transbordo.</td></tr>';
            } else {
                transferRecords.sort((a, b) => (b.timestamp?.toDate() || new Date(0)) - (a.timestamp?.toDate() || new Date(0))).forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.date}</td>
                        <td>${record.sourceTruckPlate}</td>
                        <td>${record.destinationTruckPlate}</td>
                        <td>${record.userEmail}</td>
                        <td>${record.totalItemsTransferred}</td>
                        <td>
                            <button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded-md text-sm mr-2" onclick="viewTransferDetails('${record.transferId}')">Ver Detalles</button>
                            <button class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded-md text-sm" onclick="downloadTransferRecordCSV('${record.transferId}')">Descargar CSV</button>
                        </td>
                    `;
                    transferHistoryTableBody.appendChild(row);
                });
            }
        };

        const viewTransferDetails = (transferId) => {
            const record = transferRecords.find(r => r.transferId === transferId);
            if (record) {
                let detailsMessage = `Detalles de Transbordo - Origen: ${record.sourceTruckPlate}, Destino: ${record.destinationTruckPlate}, Usuario: ${record.userEmail}, Fecha: ${record.date}\n\n`;
                record.items.forEach(item => {
                    detailsMessage += `- ${item.producto} (${item.presentacion}): ${item.cantidadTransferida} unidades\n`;
                });
                showMessageModal(detailsMessage);
            } else {
                showMessageModal('Registro de transbordo no encontrado.');
            }
        };

        const downloadTransferRecordCSV = (transferId) => {
            const record = transferRecords.find(r => r.transferId === transferId);
            if (record) {
                let csvContent = `Registro de Transbordo\n`;
                csvContent += `ID de Transbordo:,${record.transferId}\n`;
                csvContent += `Fecha:,${record.date}\n`;
                csvContent += `Camión Origen:,${record.sourceTruckPlate}\n`;
                csvContent += `Camión Destino:,${record.destinationTruckPlate}\n`;
                csvContent += `Usuario:,${record.userEmail}\n`;
                csvContent += `Total Items Transferidos:,${record.totalItemsTransferred}\n\n`;
                csvContent += `SKU,Producto,Presentacion,Cantidad Transferida,Precio Unitario\n`;
                record.items.forEach(item => {
                    csvContent += `${item.sku},${item.producto},${item.presentacion},${item.cantidadTransferida},${item.price}\n`;
                });
                downloadCSV(`transbordo_${record.sourceTruckPlate}_${record.destinationTruckPlate}_${record.date}.csv`, csvContent);
            } else {
                showMessageModal('Registro de transbordo no encontrado para descargar.');
            }
        };

        const showClearTransferHistoryConfirmation = () => {
            showConfirmationModal('¿Estás seguro de que quieres borrar TODO el historial de transbordos? Esta acción es irreversible.', clearTransferHistoryLogic);
        };

        const clearTransferHistoryLogic = async () => {
            const batch = db.batch();
            transferRecords.forEach(record => {
                const docRef = db.collection('transferRecords').doc(record.docId);
                batch.delete(docRef);
            });

            try {
                await batch.commit();
                transferRecords = []; // Limpiar el estado local
                showMessageModal('Historial de transbordos borrado exitosamente.');
                render();
            } catch (error) {
                console.error('Error al borrar historial de transbordos:', error);
                showMessageModal('Error al borrar historial de transbordos. Revisa tu conexión y reglas de seguridad.');
            }
        };


        // Registro del Service Worker
        if ('serviceWorker' in navigator) {
            document.addEventListener('DOMContentLoaded', () => {
                const serviceWorkerFileName = 'service-worker.js';
                // Usar window.location.pathname para obtener la ruta base del repositorio
                // Esto maneja casos como 'https://marvinbvivass.github.io/dist-castillo/'
                const baseUrl = window.location.pathname.endsWith('/') ? window.location.pathname : window.location.pathname + '/';
                const absoluteServiceWorkerUrl = baseUrl + serviceWorkerFileName;

                navigator.serviceWorker.register(absoluteServiceWorkerUrl)
                    .then(registration => {
                        console.log('Service Worker registrado con éxito:', registration);
                    })
                    .catch(error => {
                        console.error('Fallo el registro del Service Worker:', error);
                    });
            });
        }

        window.onload = () => {
            console.log('[window.onload] Página cargada, esperando autenticación para cargar datos.');
            render();
        };
    </script>
</body>
</html>
