<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicación de Gestión de Ventas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="flex flex-col min-h-screen">
        <header id="appHeader" class="bg-white shadow-md p-4 flex justify-between items-center hidden">
            <h1 class="text-2xl font-bold text-gray-800">Sistema de Ventas</h1>
            <div id="authStatus" class="flex items-center space-x-4">
                <span id="userIdDisplay" class="text-sm font-medium text-gray-600"></span>
                <button id="authBtn" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-300">Cargando...</button>
            </div>
        </header>

        <main id="mainContent" class="flex-grow p-6 flex items-center justify-center">
            <div class="text-center">
                <p class="text-lg text-gray-500">Cargando aplicación...</p>
            </div>
        </main>

        <footer class="p-4 text-center text-gray-500 text-sm">
            © 2025 Sistema de Gestión de Ventas. Todos los derechos reservados.
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        import { showInventarioSubMenu, setupInventario } from "./inventario.js";
        import { showVentasView, setupVentas } from "./ventas.js";

        // Configuración de Firebase incrustada para uso universal
        const firebaseConfig = {
            apiKey: "AIzaSyAiitXEEekD-7FD7kDxDIcRbxlClsF5gHU",
            authDomain: "ventas-9a210.firebaseapp.com",
            projectId: "ventas-9a210",
            storageBucket: "ventas-9a210.firebasestorage.app",
            messagingSenderId: "815890981146",
            appId: "1:815890981146:web:938fe5e09babe511e98ca3",
            measurementId: "G-N0QXG70WM1"
        };
        const appId = "ventas-9a210";

        let db;
        let auth;
        let userId;
        setLogLevel('Debug');

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }).catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        onAuthStateChanged(auth, (user) => {
            const appHeader = document.getElementById('appHeader');
            const authBtn = document.getElementById('authBtn');
            const userIdDisplay = document.getElementById('userIdDisplay');

            if (user) {
                userId = user.uid;
                setupInventario(db, userId, appId);
                setupVentas(db, userId);
                userIdDisplay.textContent = `ID de usuario: ${userId}`;
                authBtn.textContent = 'Salir';
                authBtn.onclick = () => signOut(auth);
                showMainMenuView();
                appHeader.classList.remove('hidden');
            } else {
                userId = null;
                userIdDisplay.textContent = 'No autenticado';
                authBtn.textContent = 'Iniciar Sesión';
                authBtn.onclick = () => showAuthView();
                showAuthView();
                appHeader.classList.add('hidden');
            }
        });

        const mainContent = document.getElementById('mainContent');

        function showAuthView() {
            mainContent.innerHTML = `
                <div class="p-6 bg-gray-100 min-h-screen flex items-center justify-center">
                    <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-md">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Iniciar Sesión / Registrarse</h2>
                        <form id="authForm" class="space-y-4">
                            <input type="email" id="email" placeholder="Correo electrónico" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="password" id="password" placeholder="Contraseña" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="submit" id="loginBtn" class="w-full py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-300">Iniciar Sesión</button>
                            <button type="button" id="registerBtn" class="w-full py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-300">Registrarse</button>
                        </form>
                    </div>
                </div>
            `;

            document.getElementById('authForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Error al iniciar sesión:", error);
                    // Ocultar la pantalla de inicio de sesión o mostrar un mensaje de error
                }
            });

            document.getElementById('registerBtn').addEventListener('click', async () => {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Error al registrarse:", error);
                }
            });
        }

        function showMainMenuView() {
            mainContent.innerHTML = `
                <div class="p-6 bg-gray-100 min-h-screen">
                    <div class="container mx-auto">
                        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                            <h1 class="text-3xl font-bold text-gray-800 mb-6">Menú Principal</h1>
                            <div class="space-y-4">
                                <button id="inventarioBtn" class="w-full px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                                    Inventario
                                </button>
                                <button id="ventasBtn" class="w-full px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                                    Ventas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('inventarioBtn').addEventListener('click', showInventarioSubMenu);
            document.getElementById('ventasBtn').addEventListener('click', showVentasView);
        }
    </script>
</body>
</html>
